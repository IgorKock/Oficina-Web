version: "3.8"

services:
  # Serviço para o banco de dados MariaDB
  db:
    image: mariadb:11.8 # Use uma versão específica do MariaDB, por exemplo 10.6
    restart: always # Garante que o container reinicie automaticamente
    environment:
      MYSQL_ROOT_PASSWORD: root_password # ALtere esta senha para algo seguro em produção
      MYSQL_DATABASE: oficina_web # Nome do banco de dados que sua aplicação usará
      MYSQL_USER: user_app # Usuário do banco de dados para sua aplicação
      MYSQL_PASSWORD: password_app # Senha do usuário do banco de dados para sua aplicação
    volumes:
      - db_data:/var/lib/mysql # Persiste os dados do banco de dados
    # Opcional: expõe a porta 3306 do MariaDB para o host, útil para ferramentas externas
    # ports:
    #   - "3306:3306"

  # Seu serviço da aplicação web (Flask)
  web:
    build: .
    image: igorkock/oficinaweb:latest
    container_name: oficinaweb
    ports:
      - "5000:5000"
    networks:
      - oficina_network
    # A aplicação 'web' depende do serviço 'db'
    depends_on:
      - db
    # Comando para iniciar sua aplicação
    command: python3 run.py
    environment:
      # Configuração da URL do banco de dados para a sua aplicação Flask
      # O host 'db' refere-se ao nome do serviço do MariaDB definido acima
      SQLALCHEMY_DATABASE_URI: mysql+pymysql://user_app:password_app@db:3306/oficina_web
      FLASK_APP: run.py # Garanta que este seja o nome correto do seu arquivo principal da Flask
      FLASK_ENV: development # ou production

networks:
  oficina_network:
    driver: bridge

# Definição do volume para persistência dos dados do banco de dados
volumes:
  db_data: