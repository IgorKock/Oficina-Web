{% extends "base.html" %}

{% block title %}Lista de Clientes - OficinaWeb{% endblock %}

{% block styles %}
<style>
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    .table .align-middle {
        vertical-align: middle;
    }
    .client-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #0d6efd;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
    .action-buttons a, .action-buttons button {
        margin: 0 4px;
    }
    .custom-alert-modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    .custom-alert-modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-align: center; position: relative; }
    .custom-alert-close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 15px; }
    .custom-alert-close-btn:hover, .custom-alert-close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="card border-0 shadow-sm p-3 p-md-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
            <h2 class="h4 fw-bold text-dark mb-3 mb-md-0"><i class="bi bi-people-fill text-primary me-2"></i> Listagem de Clientes</h2>
            <button type="button" class="btn btn-primary fw-bold" data-bs-toggle="modal" data-bs-target="#addClientModal">
                <i class="bi bi-plus-circle me-2"></i>Adicionar Novo Cliente
            </button>
        </div>

        <div class="row mb-3">
            <div class="col-md-8 mb-2 mb-md-0">
                <form class="input-group" method="GET" action="{{ url_for('main.client') }}">
                    <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control bg-light border-0" placeholder="Buscar por nome..." aria-label="Search" name="query" value="{{ search_query }}">
                    <button class="btn btn-outline-primary" type="submit">Buscar</button>
                </form>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Nome</th>
                        <th scope="col">Telefone(s)</th>
                        <th scope="col">CPF/CNPJ</th>
                        <th scope="col">Endereço</th>
                        <th scope="col" class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cliente in clientes %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="client-avatar me-3">{{ cliente.nome[0]|upper }}{{ cliente.apelido[0]|upper if cliente.apelido else '' }}</div>
                                <div>
                                    <a href="{{ url_for('main.cliente', id=cliente.id) }}" class="text-primary fw-bold" title="Ver Detalhes de {{ cliente.nome }}">{{ cliente.nome }}</a>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% for telefone in cliente.telefones %}{{ telefone.numero }}<br>{% else %}N/A{% endfor %}
                        </td>
                        <td>
                            {{ cliente.cpf or cliente.cnpj or "N/A" }}
                        </td>
                        <td>
                            {% if cliente.endereco %}{{ cliente.endereco.split(';')[0] }}, {{ cliente.cidade.split(';')[0] }}{% else %}N/A{% endif %}
                        </td>
                        <td class="text-center action-buttons">
                            <a href="{{ url_for('main.cliente', id=cliente.id) }}" class="btn btn-sm btn-outline-info" title="Ver Detalhes"><i class="bi bi-eye-fill"></i></a>
                            {% if current_user.is_admin() %}
                                <button type="button" class="btn btn-sm btn-outline-danger" title="Apagar Cliente" data-bs-toggle="modal" data-bs-target="#deleteClientModal{{ cliente.id }}">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- Modal de Confirmação de Exclusão -->
                    <div class="modal fade" id="deleteClientModal{{ cliente.id }}" tabindex="-1" aria-labelledby="deleteClientModalLabel{{ cliente.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteClientModalLabel{{ cliente.id }}">Confirmar Exclusão</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Tem certeza que deseja apagar o cliente <strong>{{ cliente.nome }}</strong> e todos os seus dados? Esta ação é irreversível.
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <form action="{{ url_for('main.delete_cliente', id=cliente.id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-danger">Apagar</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted p-4">Nenhum cliente encontrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Novo Cliente -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addClientModalLabel">Adicionar Novo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('main.api_add_cliente') }}" method="POST" id="addClientForm">
                    <div class="input-group mb-4">
                        <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" class="form-control" id="nome" name="nome" placeholder="Nome Completo" required>
                            <label for="nome">Nome Completo</label>
                        </div>
                    </div>
                    <div class="input-group mb-4">
                        <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" class="form-control" id="apelido" name="apelido" placeholder="Apelido ou Nome Social (Opcional)">
                            <label for="apelido">Apelido ou Nome Social (Opcional)</label>
                        </div>
                    </div>
                    <div class="input-group mb-4">
                        <span class="input-group-text"><i class="bi bi-credit-card-2-front-fill"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" class="form-control" id="cpf_cnpj" name="cpf_cnpj" placeholder="CPF ou CNPJ">
                            <label for="cpf_cnpj">CPF ou CNPJ</label>
                            <input type="hidden" name="cpf" id="hidden_cpf">
                            <input type="hidden" name="cnpj" id="hidden_cnpj">
                            <span id="cpfCnpjError" class="text-danger small" style="display: none;">Documento inválido.</span>
                        </div>
                    </div>
                    <div id="telefones-container">
                        <div class="input-group mb-4">
                            <span class="input-group-text"><i class="bi bi-phone-fill"></i></span>
                            <div class="form-floating flex-grow-1">
                                <input type="text" class="form-control telefone-input" name="numeros[]" placeholder="Telefone" required>
                                <label for="numero1">Telefone</label>
                            </div>
                            <button type="button" class="btn btn-outline-secondary" onclick="adicionarCampoTelefone()">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Custom Alert Modal HTML -->
<div id="customAlertModal" class="custom-alert-modal">
    <div class="custom-alert-modal-content">
        <span class="custom-alert-close-btn">&times;</span>
        <p id="customAlertMessage"></p>
        <button class="btn btn-primary" onclick="closeCustomAlert()">OK</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Funções de Alerta
    function showCustomAlert(message) {
        document.getElementById('customAlertMessage').innerText = message;
        document.getElementById('customAlertModal').style.display = 'flex';
    }
    function closeCustomAlert() {
        document.getElementById('customAlertModal').style.display = 'none';
    }
    document.querySelector('.custom-alert-close-btn').onclick = closeCustomAlert;
    window.onclick = function(event) {
        if (event.target == document.getElementById('customAlertModal')) closeCustomAlert();
    }

    // Adicionar/Remover Campos de Telefone
    function adicionarCampoTelefone() {
        const container = document.getElementById('telefones-container');
        const newDiv = document.createElement('div');
        newDiv.classList.add('input-group', 'mb-4');
        newDiv.innerHTML = `
            <span class="input-group-text"><i class="bi bi-phone-fill"></i></span>
            <div class="form-floating flex-grow-1">
                <input type="text" class="form-control telefone-input" name="numeros[]" placeholder="Telefone Extra">
                <label>Telefone Extra</label>
            </div>
            <button type="button" class="btn btn-outline-danger" onclick="removerCampo(this)">
                <i class="bi bi-trash"></i>
            </button>
        `;
        container.appendChild(newDiv);
        $(newDiv).find('.telefone-input').mask('(00) 00000-0000');
    }
    function removerCampo(button) {
        button.closest('.input-group').remove();
    }

   // CPF validation function (Mantido de listacliente.txt)
    function validarCPF(cpf) {
        cpf = cpf.replace(/[^\d]+/g, '');
        if (cpf == '') return false;
        if (cpf.length != 11 ||
            cpf == "00000000000" || cpf == "11111111111" || cpf == "22222222222" ||
            cpf == "33333333333" || cpf == "44444444444" || cpf == "55555555555" ||
            cpf == "66666666666" || cpf == "77777777777" || cpf == "88888888888" ||
            cpf == "99999999999")
            return false;
        let add = 0;
        for (let i = 0; i < 9; i++)
            add += parseInt(cpf.charAt(i)) * (10 - i);
        let rev = 11 - (add % 11);
        if (rev == 10 || rev == 11) rev = 0;
        if (rev != parseInt(cpf.charAt(9))) return false;
        add = 0;
        for (let i = 0; i < 10; i++)
            add += parseInt(cpf.charAt(i)) * (11 - i);
        rev = 11 - (add % 11);
        if (rev == 10 || rev == 11) rev = 0;
        if (rev != parseInt(cpf.charAt(10))) return false;
        return true;
    }
    // CNPJ validation function (Mantido de listacliente.txt)
    function validarCNPJ(cnpj) {
        cnpj = cnpj.replace(/[^\d]+/g, '');
        if (cnpj == '') return false;
        if (cnpj.length != 14) return false;
        if (cnpj == "00000000000000" || cnpj == "11111111111111" || cnpj == "22222222222222" ||
            cnpj == "33333333333333" || cnpj == "44444444444444" || cnpj == "55555555555555" ||
            cnpj == "66666666666666" || cnpj == "77777777777777" || cnpj == "88888888888888" ||
            cnpj == "99999999999999") {
            return false;
        }
        let tamanho = cnpj.length - 2;
        let numeros = cnpj.substring(0, tamanho);
        let digitos = cnpj.substring(tamanho);
        let soma = 0;
        let pos = tamanho - 7;
        for (let i = tamanho; i >= 1; i--) {
            soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
            if (pos < 2) pos = 9;
        }
        let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
        if (resultado != parseInt(digitos.charAt(0))) return false;
        tamanho = tamanho + 1;
        numeros = cnpj.substring(0, tamanho);
        soma = 0;
        pos = tamanho - 7;
        for (let i = tamanho; i >= 1; i--) {
            soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
            if (pos < 2) pos = 9;
        }
        resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
        if (resultado != parseInt(digitos.charAt(1))) return false;
        return true;
    }
    
    function validateCpfCnpjInput() {
        var cpfCnpjInput = $('#cpf_cnpj'), errorSpan = $('#cpfCnpjError');
        var hiddenCpf = $('#hidden_cpf'), hiddenCnpj = $('#hidden_cnpj');
        var valor = cpfCnpjInput.val().replace(/\D/g, '');

        errorSpan.hide();
        hiddenCpf.val('');
        hiddenCnpj.val('');

        if (valor === '') return true;
        if (valor.length === 11) {
            if (validarCPF(valor)) { hiddenCpf.val(valor); return true; }
            else { errorSpan.text('CPF inválido.').show(); return false; }
        } else if (valor.length === 14) {
            if (validarCNPJ(valor)) { hiddenCnpj.val(valor); return true; }
            else { errorSpan.text('CNPJ inválido.').show(); return false; }
        } else {
            errorSpan.text('Documento incompleto.').show(); return false;
        }
    }

    // Aplicar Máscaras e Eventos
    $(document).ready(function() {
        // Máscara CPF/CNPJ
        var cpfCnpjMask = function(val) { return val.replace(/\D/g, '').length <= 11 ? '000.000.000-009' : '00.000.000/0000-00'; };
        $('#cpf_cnpj').mask(cpfCnpjMask, { onKeyPress: function(val, e, field, options) { field.mask(cpfCnpjMask.apply({}, arguments), options); } });

        // Máscara Telefone
        $('.telefone-input').mask('(00) 00000-0000');
        
        // Evento de validação
        $('#cpf_cnpj').on('blur', validateCpfCnpjInput);

        // Limpeza de máscaras antes de submeter o formulário
        $('#addClientForm').submit(function(event) {
            if (!validateCpfCnpjInput()) {
                event.preventDefault();
                return;
            }
            $('.telefone-input').each(function() {
                $(this).val($(this).val().replace(/\D/g, ''));
            });
        });
    });
</script>
{% endblock %}