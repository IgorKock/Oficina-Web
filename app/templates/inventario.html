{% extends "base.html" %}

{% block title %}Inventário de Peças - Oficina Web{% endblock %}

{% block styles %}
<style>
    .card {
        background-color: #ffffff; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 20px; margin-top: 20px; margin-bottom: 50px; border-top: 5px solid;
        border-image: linear-gradient(to right, #007bff, #00d4ff) 1; transition: all 0.3s ease-in-out;
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12); }
    .btn-primary { background-image: linear-gradient(to right, #007bff 0%, #0056b3 100%); border: none; transition: all 0.4s ease; background-size: 200% auto; }
    .btn-primary:hover { background-position: right center; transform: scale(1.02); }
    .table-hover tbody tr:hover { background-color: #f8f9fa; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 fw-bold text-dark mb-0"><i class="bi bi-box-seam-fill text-primary me-2"></i> Inventário de Peças</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPecaModal"><i class="bi bi-plus-circle-fill me-2"></i>Adicionar Nova Peça</button>
    </div>

    <div class="card border-0 shadow-sm p-3 p-md-4 mb-4">
        <form class="input-group" method="GET" action="{{ url_for('main.inventario') }}">
            <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control bg-light border-0" placeholder="Buscar peça por nome ou descrição..." name="query" value="{{ search_query }}">
            <button class="btn btn-outline-primary" type="submit">Buscar</button>
        </form>
    </div>

    <div class="card border-0 shadow-sm p-3 p-md-4 mb-4">
        <h3 class="h5 fw-bold text-dark mb-3"><i class="bi bi-list-ul me-2"></i> Peças no Inventário</h3>
        {% if pecas %}
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Nome</th>
                        <th>Descrição</th>
                        <th>Quantidade</th>
                        <th>Preço por unidade</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for peca in pecas %}
                    <tr>
                        <td class="nome-peca">{{ peca.nome }}</td>
                        <td>{{ peca.descricao or 'N/A' }}</td>
                        <td>{{ peca.quantidade }}</td>
                        <td>R$ {{ "%.2f"|format(peca.preco) }}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-warning btn-sm me-2" data-bs-toggle="modal" data-bs-target="#editPecaModal{{ peca.id }}"><i class="bi bi-pencil-fill"></i> Editar</button>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deletePecaModal{{ peca.id }}"><i class="bi bi-trash-fill"></i> Remover</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted text-center p-3">Nenhuma peça encontrada no inventário.</p>
        {% endif %}
    </div>
</div>

<!-- Modal para Adicionar Nova Peça -->
<div class="modal fade" id="addPecaModal" tabindex="-1" aria-labelledby="addPecaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPecaModalLabel">Adicionar Nova Peça</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.add_peca') }}" method="POST" id="addPecaForm">
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-box-seam-fill"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" class="form-control" id="nome-peca" name="nome" placeholder="Nome da Peça" required>
                            <label for="nome-peca">Nome da Peça</label>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-card-text"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" class="form-control" name="descricao" placeholder="Descrição (opcional)">
                            <label for="descricao">Descrição (opcional)</label>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-hash"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="number" class="form-control" name="quantidade" placeholder="Quantidade" required>
                            <label for="quantidade">Quantidade</label>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="number" step="0.01" class="form-control" name="preco" placeholder="Preço por unidade em R$" required>
                            <label for="preco">Preço por unidade em R$</label>
                        </div>
                    </div>
                    <div id="addPecaError" class="alert alert-danger mt-2" style="display:none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar Peça</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modais para Editar Peças (um para cada peça) -->
{% for peca in pecas %}
<div class="modal fade" id="editPecaModal{{ peca.id }}" tabindex="-1" aria-labelledby="editPecaModalLabel{{ peca.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPecaModalLabel{{ peca.id }}">Editar Peça: {{ peca.nome }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.update_peca', id=peca.id) }}" method="POST">
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-box-seam-fill"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" class="form-control" name="nome" value="{{ peca.nome }}" placeholder="Nome da Peça" required>
                            <label for="nome">Nome da Peça</label>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-card-text"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" class="form-control" name="descricao" value="{{ peca.descricao or '' }}" placeholder="Descrição (opcional)">
                            <label for="descricao">Descrição (opcional)</label>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-hash"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="number" class="form-control" name="quantidade" value="{{ peca.quantidade }}" placeholder="Quantidade" required>
                            <label for="quantidade">Quantidade</label>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="number" step="0.01" class="form-control" name="preco" value="{{ peca.preco }}" placeholder="Preço por unidade em R$" required>
                            <label for="preco">Preço por unidade em R$</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão para cada peça -->
<div class="modal fade" id="deletePecaModal{{ peca.id }}" tabindex="-1" aria-labelledby="deletePecaModalLabel{{ peca.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePecaModalLabel{{ peca.id }}">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja apagar a peça <strong>{{ peca.nome }}</strong> do inventário? Esta ação é irreversível.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="{{ url_for('main.delete_peca', id=peca.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">Apagar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Custom Alert Modal HTML (de cliente.txt) -->
<div id="customAlertModal" class="custom-alert-modal">
    <div class="custom-alert-modal-content">
        <span class="custom-alert-close-btn">×</span>
        <p id="customAlertMessage"></p>
        <button class="btn btn-primary" onclick="closeCustomAlert()">OK</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    // --- LÓGICA DO MENU LATERAL (DE cliente.txt) ---
    document.addEventListener("DOMContentLoaded", function() {
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');

        if (menuToggle) {
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                // Ajusta a margem do conteúdo principal
                mainContent.classList.toggle('active-sidebar'); 
            });
        }

        // Ajuste inicial para telas menores (mobile)
        if (window.innerWidth <= 991.98) { // Usar o breakpoint do Bootstrap
            sidebar.classList.remove('active'); // Garante que a sidebar esteja escondida no mobile
            mainContent.classList.remove('active-sidebar'); // Garante que o conteúdo principal não tenha margem extra
        } else {
            sidebar.classList.add('active'); // Garante que a sidebar esteja visível no desktop
            mainContent.classList.add('active-sidebar'); // Garante que o conteúdo principal tenha margem
        }

        // Adiciona um listener para redimensionamento para ajustar o menu
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 991.98) {
                sidebar.classList.remove('active');
                mainContent.classList.remove('active-sidebar');
            } else {
                sidebar.classList.add('active');
                mainContent.classList.add('active-sidebar');
            }
        });
    });

    // --- FUNÇÕES DE ALERTA (DE cliente.txt) ---
    function showCustomAlert(message) {
        document.getElementById('customAlertMessage').innerText = message;
        document.getElementById('customAlertModal').style.display = 'flex';
    }
    function closeCustomAlert() {
        document.getElementById('customAlertModal').style.display = 'none';
    }
    document.querySelector('.custom-alert-close-btn').onclick = closeCustomAlert;
    window.onclick = function(event) {
        if (event.target == document.getElementById('customAlertModal')) closeCustomAlert();
    }

    // --- FUNÇÃO PARA VALIDAR SE A PEÇA JÁ EXISTE (evita duplicidade) ---
    // Adaptada para o modal de adição
    document.getElementById('addPecaForm').addEventListener('submit', function(event) {
        let pecasExistentes = Array.from(document.querySelectorAll("td.nome-peca")).map(td => td.innerText.trim().toLowerCase());
        let nomeInput = document.getElementById("nome-peca");
        let nomeDigitado = nomeInput.value.trim().toLowerCase();
        let errorDiv = document.getElementById("addPecaError");

        errorDiv.style.display = 'none'; // Esconde mensagens de erro anteriores
        errorDiv.textContent = '';

        if (pecasExistentes.includes(nomeDigitado)) {
            errorDiv.textContent = "Erro: Esta peça já está cadastrada!";
            errorDiv.style.display = 'block';
            event.preventDefault(); // Impede o envio do formulário
        }
    });

    // --- LÓGICA PARA EXIBIR MENSAGENS DE ERRO DA URL (adaptado) ---
    document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);
        const errorMessage = params.get("error");

        if (errorMessage) {
            showCustomAlert(errorMessage); // Usa o modal de alerta personalizado
            // Remove o erro da URL sem recarregar a página para uma experiência mais limpa
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    });

    // --- FUNÇÕES DE MÁSCARA ---
    function applyMasks() {
        // Nenhuma máscara específica para inputs de inventário é necessária aqui,
        // mas mantemos a função caso queira adicionar no futuro.
    }

    $(document).ready(function() {
        applyMasks();
    });
</script>
{% endblock %}