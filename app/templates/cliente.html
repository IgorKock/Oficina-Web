<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Cliente - OficinaWeb</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* ESTILOS DA ESTRUTURA (BASEADO EM listacliente.txt) */
        :root {
            --sidebar-width: 260px;
            --header-height: 60px;
        }
        
        body {
            background-color: #f0f2f5;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cg fill='%23d3dce3' fill-opacity='0.4'%3E%3Cpath fill-rule='evenodd' d='M0 0h4v4H0V0zm4 4h4v4H4V4z'/%3E%3C/g%3E%3C/svg%3E");
            font-family: 'Poppins', sans-serif;
            padding-top: var(--header-height);
            margin: 0;
            overflow-x: hidden;
        }

        .header {
            height: var(--header-height);
            z-index: 1030;
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1020;
            background-color: #fff;
            padding-top: var(--header-height);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            transition: margin-left 0.3s ease-in-out;
        }
        .sidebar .nav-link {
            color: #555;
            font-weight: 500;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .sidebar .nav-link .bi {
            font-size: 1.2rem;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: #0d6efd;
            background-color: #e9f2ff;
            border-right: 3px solid #0d6efd;
        }

        .main-content {
            padding: 30px;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease-in-out;
        }
        
        @media (max-width: 991.98px) {
            .sidebar {
                margin-left: calc(-1 * var(--sidebar-width));
            }
            .sidebar.active {
                margin-left: 0;
            }
            .main-content {
                margin-left: 0;
            }
        }
        
        /* --- ESTILOS DAS ABAS (ADAPTADOS DE cliente.txt) --- */
        .card-header-tabs .nav-link {
            color: #495057;
            font-weight: 500;
        }
        .card-header-tabs .nav-link.active {
            color: #0d6efd;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
            font-weight: 600;
        }
        .tab-content {
            padding-top: 1rem;
        }

        /* --- CUSTOM ALERT MODAL --- */
        .custom-alert-modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .custom-alert-modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-align: center; position: relative; }
        .custom-alert-close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 15px; }
        .custom-alert-close-btn:hover, .custom-alert-close-btn:focus { color: black; text-decoration: none; cursor: pointer; }

        /* --- ESTILOS DE IMPRESSÃO --- */
        #print-sections-container .print-section {
            display: none;
        }
    </style>
</head>
<body>

<header class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top header">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" id="menu-toggle">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand fw-bold text-primary" href="#">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Empresa" style="max-width: 40px; height: auto; margin-right: 10px;">
            Oficina Web
        </a>
        <div class="d-flex align-items-center">
            <span class="navbar-text me-3">Bem-vindo, {{ current_user.nome }}!</span>
            <a href="{{ url_for('main.logout') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-box-arrow-right"></i> Sair</a>
        </div>
    </div>
</header>

<aside class="sidebar">
    <div class="p-3"><h5 class="text-muted fw-bold">Menu Lateral</h5></div>
    <ul class="nav nav-pills flex-column">
        <li class="nav-item">
            <a href="{{ url_for('main.index') }}" class="nav-link"><i class="bi bi-speedometer2"></i> Página Inicial</a>
        </li>
        <li class="nav-item">
            <a href="{{ url_for('main.client') }}" class="nav-link active"><i class="bi bi-people-fill"></i> Clientes</a>
        </li>
        <li class="nav-item">
            <a href="{{ url_for('main.inventario') }}" class="nav-link"><i class="bi bi-box-seam-fill"></i> Inventário</a>
        </li>
        <li class="nav-item">
            <a href="{{ url_for('main.lista_utilizadores') }}" class="nav-link"><i class="bi bi-people"></i> Usuários</a>
        </li>
    </ul>
</aside>

<main class="main-content">
    <div class="container-fluid">

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4 fw-bold text-dark mb-0"><i class="bi bi-person-lines-fill text-primary me-2"></i> Detalhes do Cliente: {{ cliente.nome }}</h2>
            <a href="{{ url_for('main.client') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-2"></i>Voltar para a Lista</a>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <ul class="nav nav-tabs card-header-tabs" id="clientTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dados-pessoais-tab" data-bs-toggle="tab" data-bs-target="#dados-pessoais-pane" type="button" role="tab" aria-controls="dados-pessoais-pane" aria-selected="true">Dados Pessoais</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="veiculos-tab" data-bs-toggle="tab" data-bs-target="#veiculos-pane" type="button" role="tab" aria-controls="veiculos-pane" aria-selected="false">Veículos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="telefones-tab" data-bs-toggle="tab" data-bs-target="#telefones-pane" type="button" role="tab" aria-controls="telefones-pane" aria-selected="false">Telefones</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pagamentos-tab" data-bs-toggle="tab" data-bs-target="#pagamentos-pane" type="button" role="tab" aria-controls="pagamentos-pane" aria-selected="false">Pagamentos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="print-tab" data-bs-toggle="tab" data-bs-target="#print-pane" type="button" role="tab" aria-controls="print-pane" aria-selected="false">Imprimir</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="clientTabContent">
                    
                    <!-- Aba: Dados Pessoais -->
                    <div class="tab-pane fade show active" id="dados-pessoais-pane" role="tabpanel" aria-labelledby="dados-pessoais-tab">
                        <h4 class="mb-3">Dados Pessoais</h4>
						<div class="row">
							<div class="col-md-6">
								<p class="mb-2"><strong>Nome:</strong> {{ cliente.nome }}</p>
								<p class="mb-2"><strong>Apelido ou Nome Social:</strong> {{ cliente.apelido or "N/A" }}</p>
								<p class="mb-2"><strong>CPF:</strong> {{ cliente.cpf or "N/A" }}</p>
								<p class="mb-2"><strong>CNPJ:</strong> {{ cliente.cnpj or "N/A" }}</p>
							</div>
							<div class="col-md-6">
								{% if cliente.endereco %}
									{% for endereco in cliente.endereco.split(';') %}
										<p class="mb-2"><strong>Endereço {{ loop.index }}:</strong> {{ endereco.strip() }}</p>
									{% endfor %}
								{% else %}
									<p class="mb-2"><strong>Endereço:</strong> N/A</p>
								{% endif %}
								{% if cliente.bairro %}
									{% for bairro in cliente.bairro.split(';') %}
										<p class="mb-2"><strong>Bairro {{ loop.index }}:</strong> {{ bairro.strip() }}</p>
									{% endfor %}
								{% else %}
									<p class="mb-2"><strong>Bairro:</strong> N/A</p>
								{% endif %}
								{% if cliente.cidade %}
									{% for cidade in cliente.cidade.split(';') %}
										<p class="mb-2"><strong>Cidade {{ loop.index }}:</strong> {{ cidade.strip() }}</p>
									{% endfor %}
								{% else %}
									<p class="mb-2"><strong>Cidade:</strong> N/A</p>
								{% endif %}
								<p class="mb-2"><strong>Estado:</strong> {{ cliente.estado or "N/A" }}</p>
								{% if cliente.cep %}
									{% for cep in cliente.cep.split(';') %}
										<p class="mb-2"><strong>CEP {{ loop.index }}:</strong> {{ cep.strip() }}</p>
									{% endfor %}
								{% else %}
									<p class="mb-2"><strong>CEP:</strong> N/A</p>
								{% endif %}
							</div>
						</div>
						<hr>
						<div class="mt-4">
							<h5 class="mb-3">Atualizar Informações</h5>
							<form action="{{ url_for('main.update_dados_cliente', cliente_id=cliente.id) }}" method="POST" id="editClientForm">
								<div class="row">
									<div class="col-md-6 mb-3">
										<label for ="apelido" class="form-label">Apelido ou Nome Social</label>
										<input type="text" name="apelido" class="form-control" placeholder="Apelido ou Nome Social" value="{{ cliente.apelido or '' }}">
									</div>
									<div class="col-md-6 mb-3">
										<label for="cpf_cnpj" class="form-label">CPF/CNPJ</label>
										<input type="text" id="cpf_cnpj" class="form-control" placeholder="CPF ou CNPJ" value="{{ cliente.cpf or cliente.cnpj or '' }}">
										<input type="hidden" name="cpf" id="hidden_cpf" value="{{ cliente.cpf or '' }}">
										<input type="hidden" name="cnpj" id="hidden_cnpj" value="{{ cliente.cnpj or '' }}">
										<span id="cpfCnpjError" class="text-danger small" style="display: none;">Documento inválido.</span>
									</div>
								</div>

								<div id="enderecos-container">
                                    <div class="mb-3 border p-3 rounded bg-light">
                                        <h6 class="mb-3">Endereço Principal</h6>
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <label for="cep" class="form-label">CEP</label>
                                                <input type="text" name="cep[]" class="form-control cep-input" placeholder="CEP" value="{{ cliente.cep or ''}}" id="mainCepInput">
                                            </div>
                                            <div class="col-md-9 mb-3">
                                                <label for="endereco" class="form-label">Endereço</label>
                                                <input type="text" name="endereco[]" class="form-control" placeholder="Endereço" value="{{ cliente.endereco or ''}}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="bairro" class="form-label">Bairro</label>
                                                <input type="text" name="bairro[]" class="form-control" placeholder="Bairro" value="{{ cliente.bairro or ''}}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="cidade" class="form-label">Cidade</label>
                                                <input type="text" name="cidade[]" class="form-control" placeholder="Cidade" value="{{ cliente.cidade or ''}}">
                                            </div>
                                        </div>
                                    </div>
								</div>
                                <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="adicionarCampoEndereco()">
                                    <i class="bi bi-plus-circle"></i> Adicionar outro endereço
                                </button>
								
								<div class="row">
									<div class="col-md-4 mb-3">
										<label for="estado" class="form-label">Estado</label>
										<select name="estado" class="form-select">
											<option value="">Selecione...</option>
											<option value="AC" {% if cliente.estado == 'AC' %}selected{% endif %}>Acre</option>
											<option value="AL" {% if cliente.estado == 'AL' %}selected{% endif %}>Alagoas</option>
											<option value="AP" {% if cliente.estado == 'AP' %}selected{% endif %}>Amapá</option>
											<option value="AM" {% if cliente.estado == 'AM' %}selected{% endif %}>Amazonas</option>
											<option value="BA" {% if cliente.estado == 'BA' %}selected{% endif %}>Bahia</option>
											<option value="CE" {% if cliente.estado == 'CE' %}selected{% endif %}>Ceará</option>
											<option value="DF" {% if cliente.estado == 'DF' %}selected{% endif %}>Distrito Federal</option>
											<option value="ES" {% if cliente.estado == 'ES' %}selected{% endif %}>Espírito Santo</option>
											<option value="GO" {% if cliente.estado == 'GO' %}selected{% endif %}>Goiás</option>
											<option value="MA" {% if cliente.estado == 'MA' %}selected{% endif %}>Maranhão</option>
											<option value="MT" {% if cliente.estado == 'MT' %}selected{% endif %}>Mato Grosso</option>
											<option value="MS" {% if cliente.estado == 'MS' %}selected{% endif %}>Mato Grosso do Sul</option>
											<option value="MG" {% if cliente.estado == 'MG' %}selected{% endif %}>Minas Gerais</option>
											<option value="PA" {% if cliente.estado == 'PA' %}selected{% endif %}>Pará</option>
											<option value="PB" {% if cliente.estado == 'PB' %}selected{% endif %}>Paraíba</option>
											<option value="PR" {% if cliente.estado == 'PR' %}selected{% endif %}>Paraná</option>
											<option value="PE" {% if cliente.estado == 'PE' %}selected{% endif %}>Pernambuco</option>
											<option value="PI" {% if cliente.estado == 'PI' %}selected{% endif %}>Piauí</option>
											<option value="RJ" {% if cliente.estado == 'RJ' %}selected{% endif %}>Rio de Janeiro</option>
											<option value="RN" {% if cliente.estado == 'RN' %}selected{% endif %}>Rio Grande do Norte</option>
											<option value="RS" {% if cliente.estado == 'RS' %}selected{% endif %}>Rio Grande do Sul</option>
											<option value="RO" {% if cliente.estado == 'RO' %}selected{% endif %}>Rondônia</option>
											<option value="RR" {% if cliente.estado == 'RR' %}selected{% endif %}>Roraima</option>
											<option value="SC" {% if cliente.estado == 'SC' %}selected{% endif %}>Santa Catarina</option>
											<option value="SP" {% if cliente.estado == 'SP' %}selected{% endif %}>São Paulo</option>
											<option value="SE" {% if cliente.estado == 'SE' %}selected{% endif %}>Sergipe</option>
											<option value="TO" {% if cliente.estado == 'TO' %}selected{% endif %}>Tocantins</option>
										</select>
									</div>
								</div>
								<button type="submit" class="btn btn-primary"><i class="bi bi-check-circle me-2"></i>Atualizar Dados</button>
							</form>
						</div>
                    </div>

                    <!-- Aba: Veículos -->
                    <div class="tab-pane fade" id="veiculos-pane" role="tabpanel" aria-labelledby="veiculos-tab">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<h4 class="mb-0">Veículos do Cliente</h4>
							<button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addCarroModal"><i class="bi bi-plus-circle me-1"></i>Adicionar Veículo</button>
						</div>
						
						{% if carros %}
							{% for carro in carros %}
								<div class="card mb-3">
									<div class="card-header d-flex justify-content-between align-items-center">
										<h5 class="mb-0">{{ carro.marca }} {{ carro.modelo }} ({{ carro.ano }}) - {{ carro.placa }}</h5>
										<div>
											<button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#updateCarroModal{{ carro.id }}"><i class="bi bi-pencil-fill"></i></button>
										</div>
									</div>
									<div class="card-body">
										<p><strong>Motor:</strong> {{ carro.motor or 'N/A' }} | <strong>Quilometragem:</strong> {{ carro.quilometragem or 'N/A' }} KMs</p>
										
										<h6 class="mt-4">Histórico de Serviços</h6>
										{% if carro.historicos %}
											<table class="table table-sm table-striped table-hover">
												<thead>
													<tr>
														<th>Data</th>
														<th>Descrição do Serviço</th>
														<th class="text-end">Ações</th>
													</tr>
												</thead>
												<tbody>
													{% for historico in carro.historicos %}
													<tr>
														<td>{{ historico.data_local.strftime('%d/%m/%Y %H:%M') if historico.data_local else '' }}</td>
														<td>{{ historico.descricao }}</td>
														<td class="text-end">
															<button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editHistoricoModal{{ historico.id }}"><i class="bi bi-pencil"></i></button>
															<form action="{{ url_for('main.delete_historico', id=historico.id) }}" method="POST" class="d-inline">
																<button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza?');"><i class="bi bi-trash"></i></button>
															</form>
														</td>
													</tr>
													{% endfor %}
												</tbody>
											</table>
										{% else %}
											<p class="text-muted">Nenhum histórico de serviço registrado.</p>
										{% endif %}
										
										<div class="mt-3">
											<form action="/add_historico/{{ carro.id }}" method="POST" class="row gx-2 align-items-end">
												<div class="col">
													<label for="descricao_hist" class="form-label small">Novo Histórico</label>
													<input type="text" name="descricao" placeholder="Descrição do serviço" class="form-control form-control-sm" required>
												</div>
												<div class="col-md-3">
													<label for="data_hist" class="form-label small">Data</label>
													<input type="date" name="data" class="form-control form-control-sm" required>
												</div>
												<div class="col-auto">
													<button type="submit" class="btn btn-primary btn-sm">Adicionar</button>
												</div>
											</form>
										</div>
									</div>
								</div>

								<!-- Modal para Editar Carro -->
								<div class="modal fade" id="updateCarroModal{{ carro.id }}" tabindex="-1" aria-hidden="true">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="modal-title">Editar Veículo</h5>
												<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
											</div>
											<form action="{{ url_for('main.update_carros', cliente_id=cliente.id) }}" method="POST">
												<div class="modal-body">
													<input type="hidden" name="carro_id" value="{{ carro.id }}">
													<div class="mb-3"><label class="form-label">Marca</label><input type="text" name="marca_{{ carro.id }}" class="form-control" value="{{ carro.marca }}" required></div>
													<div class="mb-3"><label class="form-label">Modelo</label><input type="text" name="modelo_{{ carro.id }}" class="form-control" value="{{ carro.modelo }}" required></div>
													<div class="mb-3"><label class="form-label">Motor</label><input type="text" name="motor_{{ carro.id }}" class="form-control" value="{{ carro.motor }}"></div>
													<div class="mb-3"><label class="form-label">Ano</label><input type="number" name="ano_{{ carro.id }}" class="form-control ano-input" value="{{ carro.ano }}"></div>
													<div class="mb-3"><label class="form-label">Placa</label><input type="text" name="placa_{{ carro.id }}" class="form-control placa-input" value="{{ carro.placa }}"></div>
													<div class="mb-3"><label class="form-label">Quilometragem</label><input type="number" name="quilometragem_{{ carro.id }}" class="form-control" value="{{ carro.quilometragem }}"></div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
													<button type="submit" class="btn btn-primary">Salvar Alterações</button>
												</div>
											</form>
										</div>
									</div>
								</div>

								<!-- Modais para Editar Histórico (um para cada histórico) -->
								{% for historico in carro.historicos %}
								<div class="modal fade" id="editHistoricoModal{{ historico.id }}" tabindex="-1" aria-hidden="true">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header"><h5 class="modal-title">Editar Histórico</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
											<form action="{{ url_for('main.edit_historico', id=historico.id) }}" method="POST">
												<div class="modal-body">
													<div class="mb-3"><label class="form-label">Descrição</label><input type="text" class="form-control" name="descricao" value="{{ historico.descricao }}" required></div>
													<div class="mb-3"><label class="form-label">Data</label><input type="date" class="form-control" name="data" value="{{ historico.data_local.strftime('%Y-%m-%d') if historico.data_local else '' }}" required></div>
												</div>
												<div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
											</form>
										</div>
									</div>
								</div>
								{% endfor %}
							{% endfor %}
						{% else %}
							<div class="text-center p-4 border rounded bg-light">
								<p class="mb-0 text-muted">Nenhum veículo registrado para este cliente.</p>
							</div>
						{% endif %}
                    </div>

                    <!-- Aba: Telefones -->
                    <div class="tab-pane fade" id="telefones-pane" role="tabpanel" aria-labelledby="telefones-tab">
						<h4 class="mb-3">Telefones do Cliente</h4>
						{% if telefones %}
							<ul class="list-group mb-4">
								{% for telefone in telefones %}
									<li class="list-group-item d-flex justify-content-between align-items-center">
										<span>{{ telefone.numero }}</span>
										<div>
											<!-- Formulário de atualização é melhor em um modal para evitar poluição -->
											<form action="{{ url_for('main.delete_telefone', telefone_id=telefone.id) }}" method="POST" class="d-inline">
												<button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza?');"><i class="bi bi-trash"></i></button>
											</form>
										</div>
									</li>
								{% endfor %}
							</ul>
						{% else %}
							<p class="text-muted">Nenhum telefone registrado.</p>
						{% endif %}
						<hr>
						<h5 class="mt-4 mb-3">Adicionar Novos Telefones</h5>
						<form action="{{ url_for('main.add_telefone', cliente_id=cliente.id) }}" method="POST" id="addTelefoneForm">
							<div id="telefones-container-add">
								<div class="input-group mb-2">
									<input type="text" name="numeros[]" class="form-control telefone-input" placeholder="Digite o Telefone" required>
									<button class="btn btn-outline-secondary" type="button" onclick="adicionarCampoTelefone()"><i class="bi bi-plus-circle"></i></button>
								</div>
							</div>
							<button type="submit" class="btn btn-primary mt-2">Salvar Telefone(s)</button>
						</form>
                    </div>

                    <!-- Aba: Pagamentos -->
                    <div class="tab-pane fade" id="pagamentos-pane" role="tabpanel" aria-labelledby="pagamentos-tab">
						<h4 class="mb-3">Pagamentos do Cliente</h4>
						{% if pagamentos %}
							<div class="table-responsive">
								<table class="table table-hover align-middle">
									<thead class="table-light">
										<tr>
											<th>Veículo</th>
											<th>Serviço</th>
											<th>Data</th>
											<th>Valor (R$)</th>
											<th>Método</th>
											<th class="text-end">Ações</th>
										</tr>
									</thead>
									<tbody>
										{% for pagamento in pagamentos %}
										<tr>
											<td>{{ pagamento.carro.marca }} {{ pagamento.carro.modelo }}</td>
											<td>{{ pagamento.historico.descricao }}</td>
											<td>{{ pagamento.data_local.strftime('%d/%m/%Y') if pagamento.data_local else '' }}</td>
											<td>R$ {{ "%.2f"|format(pagamento.valor) }}</td>
											<td>{{ pagamento.metodo }} {% if pagamento.tipo_pagamento == 'Parcelado' %}({{ pagamento.parcelas }}x){% endif %}</td>
											<td class="text-end">
												<button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editPagamentoModal{{ pagamento.id }}"><i class="bi bi-pencil"></i></button>
												<form action="{{ url_for('main.delete_pagamento', id=pagamento.id) }}" method="POST" class="d-inline">
													<button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza?');"><i class="bi bi-trash"></i></button>
												</form>
											</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						{% else %}
							<p class="text-muted">Nenhum pagamento registrado.</p>
						{% endif %}
						<hr>
						<h5 class="mt-4 mb-3">Registrar Novo Pagamento</h5>
						{% set servicos_sem_pagamento = namespace(count=0) %}
						{% for carro in carros %}
							{% for historico in carro.historicos %}
								{% if not historico.tem_pagamento %}
									{% set servicos_sem_pagamento.count = servicos_sem_pagamento.count + 1 %}
									<form id="form_pagamento_{{ historico.id }}" action="{{ url_for('main.add_pagamento', cliente_id=cliente.id, carro_id=carro.id, historico_id=historico.id) }}" method="POST" class="mb-4 p-3 border rounded bg-light">
										<p class="fw-bold">Para: {{ historico.descricao }} ({{ carro.marca }} {{ carro.modelo }})</p>
										<div class="row">
											<div class="col-md-3 mb-3"><label class="form-label">Valor (R$)</label><input type="number" step="0.01" name="valor" class="form-control" required></div>
											<div class="col-md-3 mb-3"><label class="form-label">Método</label><select name="metodo" class="form-select" required onchange="toggleOpcaoPagamento(event)"><option value="Dinheiro">Dinheiro</option><option value="Cartão de Crédito">Cartão de Crédito</option><option value="Cartão de Débito">Cartão de Débito</option><option value="Pix">Pix</option></select></div>
											<div class="col-md-4 mb-3 opcaoCartao" style="display: none;">
												<div class="row">
													<div class="col-6"><label class="form-label">Tipo</label><select name="tipo_pagamento" class="form-select" onchange="toggleParcelas(event)"><option value="À vista">À vista</option><option value="Parcelado">Parcelado</option></select></div>
													<div class="col-6 opcaoParcelado" style="display: none;"><label class="form-label">Parcelas</label><input type="number" name="parcelas" min="1" max="12" class="form-control"></div>
												</div>
											</div>
											<div class="col-md-2 mb-3"><label class="form-label">Data</label><input type="date" name="data_pagamento" class="form-control" required></div>
											<div class="col-md-12"><button type="submit" class="btn btn-primary">Registrar</button></div>
										</div>
									</form>
								{% endif %}
							{% endfor %}
						{% endfor %}
						{% if servicos_sem_pagamento.count == 0 and carros %}
							<p class="text-success">Todos os serviços já possuem pagamentos registrados.</p>
						{% endif %}

						<!-- Modais para editar pagamentos -->
						{% for pagamento in pagamentos %}
						<div class="modal fade" id="editPagamentoModal{{ pagamento.id }}" tabindex="-1" aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header"><h5 class="modal-title">Editar Pagamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
									<form action="{{ url_for('main.edit_pagamento', id=pagamento.id) }}" method="POST">
										<div class="modal-body">
											<div class="mb-3"><label class="form-label">Valor (R$)</label><input type="number" step="0.01" class="form-control" name="valor" value="{{ "%.2f"|format(pagamento.valor) }}" required></div>
											<div class="mb-3"><label class="form-label">Método</label><select class="form-select" name="metodo" required onchange="toggleOpcaoPagamento(event)"><option value="Dinheiro" {% if pagamento.metodo == 'Dinheiro' %}selected{% endif %}>Dinheiro</option><option value="Cartão de Crédito" {% if pagamento.metodo == 'Cartão de Crédito' %}selected{% endif %}>Cartão de Crédito</option><option value="Cartão de Débito" {% if pagamento.metodo == 'Cartão de Débito' %}selected{% endif %}>Cartão de Débito</option><option value="Pix" {% if pagamento.metodo == 'Pix' %}selected{% endif %}>Pix</option></select></div>
											<div class="opcaoCartao" {% if pagamento.metodo != 'Cartão de Crédito' %}style="display: none;"{% endif %}>
												<div class="mb-3"><label class="form-label">Tipo</label><select class="form-select" name="tipo_pagamento" onchange="toggleParcelas(event)"><option value="À vista" {% if pagamento.tipo_pagamento == 'À vista' %}selected{% endif %}>À vista</option><option value="Parcelado" {% if pagamento.tipo_pagamento == 'Parcelado' %}selected{% endif %}>Parcelado</option></select></div>
												<div class="mb-3 opcaoParcelado" {% if pagamento.tipo_pagamento != 'Parcelado' %}style="display: none;"{% endif %}><label class="form-label">Parcelas</label><input type="number" class="form-control" name="parcelas" min="1" max="12" value="{{ pagamento.parcelas or '' }}"></div>
											</div>
										</div>
										<div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
									</form>
								</div>
							</div>
						</div>
						{% endfor %}
                    </div>

                    <!-- Aba: Imprimir -->
                    <div class="tab-pane fade" id="print-pane" role="tabpanel" aria-labelledby="print-tab">
						<h4 class="mb-3">Seleção para Impressão</h4>
						<form id="print-form" class="mb-3">
							<div class="form-check"><input type="checkbox" id="checkbox-print-dados-pessoais" class="form-check-input"><label class="form-check-label" for="checkbox-print-dados-pessoais">Dados Pessoais</label></div>
							<div class="form-check"><input type="checkbox" id="checkbox-print-veiculos" class="form-check-input"><label class="form-check-label" for="checkbox-print-veiculos">Veículos e Históricos</label></div>
							<div class="form-check"><input type="checkbox" id="checkbox-print-telefones" class="form-check-input"><label class="form-check-label" for="checkbox-print-telefones">Telefones</label></div>
							<div class="form-check"><input type="checkbox" id="checkbox-print-pagamentos" class="form-check-input"><label class="form-check-label" for="checkbox-print-pagamentos">Pagamentos</label></div>
						</form>
						<button type="button" class="btn btn-primary" onclick="imprimirSelecionados()"><i class="bi bi-printer-fill me-2"></i>Imprimir Selecionados</button>
						
						<!-- Conteúdo oculto para impressão -->
						<div id="print-sections-container">
							<div id="print-section-dados-pessoais" class="print-section">
								<h4>Dados Pessoais</h4>
								<p><strong>Nome:</strong> {{ cliente.nome }}</p>
								<p><strong>CPF/CNPJ:</strong> {{ cliente.cpf or cliente.cnpj or "N/A" }}</p>
								<p><strong>Endereço:</strong> {% if cliente.endereco %}{{ cliente.endereco.split(';')[0].strip() }}, {{ cliente.cidade.split(';')[0].strip() }} - {{ cliente.estado }}{% else %}N/A{% endif %}</p>
							</div>
							<div id="print-section-telefones" class="print-section">
								<h4>Telefones</h4>
								{% for telefone in telefones %}<p>{{ telefone.numero }}</p>{% endfor %}
							</div>
							<div id="print-section-veiculos" class="print-section">
								<h4>Veículos e Históricos</h4>
								{% for carro in carros %}
									<div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ccc;">
										<p><strong>Veículo:</strong> {{ carro.marca }} {{ carro.modelo }} ({{ carro.ano }}) - Placa: {{ carro.placa }}</p>
										<ul>{% for historico in carro.historicos %}<li><strong>{{ historico.data_local.strftime('%d/%m/%Y') }}:</strong> {{ historico.descricao }}</li>{% endfor %}</ul>
									</div>
								{% endfor %}
							</div>
							<div id="print-section-pagamentos" class="print-section">
								<h4>Pagamentos</h4>
								<table class="table table-sm">
									<thead><tr><th>Data</th><th>Serviço</th><th>Valor</th><th>Método</th></tr></thead>
									<tbody>
									{% for pagamento in pagamentos %}
										<tr>
											<td>{{ pagamento.data_local.strftime('%d/%m/%Y') }}</td>
											<td>{{ pagamento.historico.descricao }}</td>
											<td>R$ {{ "%.2f"|format(pagamento.valor) }}</td>
											<td>{{ pagamento.metodo }}</td>
										</tr>
									{% endfor %}
									</tbody>
								</table>
							</div>
						</div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<!-- Modal para Adicionar Novo Carro -->
<div class="modal fade" id="addCarroModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Adicionar Novo Veículo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form action="{{ url_for('main.add_carros', cliente_id=cliente.id) }}" method="POST" id="addCarroForm">
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">Marca</label><input type="text" name="marca[]" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Modelo</label><input type="text" name="modelo[]" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Motor</label><input type="text" name="motor[]" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">Ano</label><input type="number" name="ano[]" class="form-control ano-input"></div>
                    <div class="mb-3"><label class="form-label">Placa</label><input type="text" name="placa[]" class="form-control placa-input"></div>
                    <div class="mb-3"><label class="form-label">Quilometragem</label><input type="number" name="quilometragem[]" class="form-control"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Veículo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Custom Alert Modal HTML -->
<div id="customAlertModal" class="custom-alert-modal">
    <div class="custom-alert-modal-content">
        <span class="custom-alert-close-btn">×</span>
        <p id="customAlertMessage"></p>
        <button class="btn btn-primary" onclick="closeCustomAlert()">OK</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    // --- LÓGICA DO MENU LATERAL (DE listacliente.txt) ---
    document.addEventListener("DOMContentLoaded", function() {
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        if (menuToggle) {
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });
        }
    });

    // --- FUNÇÕES DE ALERTA ---
    function showCustomAlert(message) {
        document.getElementById('customAlertMessage').innerText = message;
        document.getElementById('customAlertModal').style.display = 'flex';
    }
    function closeCustomAlert() {
        document.getElementById('customAlertModal').style.display = 'none';
    }
    document.querySelector('.custom-alert-close-btn').onclick = closeCustomAlert;
    window.onclick = function(event) {
        if (event.target == document.getElementById('customAlertModal')) closeCustomAlert();
    }

    // --- FUNÇÕES DE MANIPULAÇÃO DO FORMULÁRIO ---
    function adicionarCampoTelefone() {
        const container = document.getElementById('telefones-container-add');
        const newDiv = document.createElement('div');
        newDiv.classList.add('input-group', 'mb-2');
        newDiv.innerHTML = `
            <input type="text" name="numeros[]" class="form-control telefone-input" placeholder="Telefone adicional" required>
            <button type="button" class="btn btn-outline-danger" onclick="this.closest('.input-group').remove();"><i class="bi bi-trash"></i></button>
        `;
        container.appendChild(newDiv);
        $(newDiv).find('.telefone-input').mask('(00) 00000-0000');
    }

    function adicionarCampoEndereco() {
        const container = document.getElementById('enderecos-container');
        const newDiv = document.createElement('div');
        newDiv.classList.add('mb-3', 'border', 'p-3', 'rounded', 'bg-light', 'position-relative');
        newDiv.innerHTML = `
            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close" onclick="this.closest('.mb-3').remove();"></button>
            <h6 class="mb-3">Endereço Adicional</h6>
            <div class="row">
                <div class="col-md-3 mb-3"><label class="form-label">CEP</label><input type="text" name="cep[]" class="form-control cep-input" placeholder="CEP"></div>
                <div class="col-md-9 mb-3"><label class="form-label">Endereço</label><input type="text" name="endereco[]" class="form-control" placeholder="Endereço"></div>
                <div class="col-md-6 mb-3"><label class="form-label">Bairro</label><input type="text" name="bairro[]" class="form-control" placeholder="Bairro"></div>
                <div class="col-md-6 mb-3"><label class="form-label">Cidade</label><input type="text" name="cidade[]" class="form-control" placeholder="Cidade"></div>
            </div>
        `;
        container.appendChild(newDiv);
        const newCepInput = newDiv.querySelector('.cep-input');
        $(newCepInput).mask('00000-000');
        newCepInput.addEventListener('blur', () => preencherEnderecoPorCep(newCepInput));
    }

    function toggleOpcaoPagamento(event) {
        const form = event.target.closest("form, .modal-body");
        const opcaoCartao = form.querySelector(".opcaoCartao");
        if (event.target.value === "Cartão de Crédito") {
            opcaoCartao.style.display = "block";
        } else {
            opcaoCartao.style.display = "none";
            const opcaoParcelado = form.querySelector(".opcaoParcelado");
            if (opcaoParcelado) opcaoParcelado.style.display = "none";
        }
    }

    function toggleParcelas(event) {
        const form = event.target.closest("form, .modal-body");
        const opcaoParcelado = form.querySelector(".opcaoParcelado");
        if (event.target.value === "Parcelado") {
            opcaoParcelado.style.display = "block";
        } else {
            opcaoParcelado.style.display = "none";
        }
    }

    function imprimirSelecionados() {
        const printContent = document.createElement('div');
        let hasSelection = false;
        document.querySelectorAll('#print-form .form-check-input').forEach(checkbox => {
            if (checkbox.checked) {
                hasSelection = true;
                const sectionId = checkbox.id.replace('checkbox-print-', 'print-section-');
                const section = document.getElementById(sectionId);
                if (section) printContent.innerHTML += section.innerHTML;
            }
        });

        if (!hasSelection) {
            showCustomAlert('Selecione pelo menos uma seção para imprimir.');
            return;
        }

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html><head><title>Impressão do Cliente</title>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
            <style>body{padding:20px;} h4{margin-top:20px;border-bottom:1px solid #ccc;padding-bottom:5px;}</style>
            </head><body>
            <div align="center"><img src="{{ url_for('static', filename='img/logo.png') }}" width="150"></div>
            <hr>
            ${printContent.innerHTML}
            </body></html>`);
        printWindow.document.close();
        printWindow.print();
    }

    function preencherEnderecoPorCep(cepInput) {
        let cep = cepInput.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        const group = cepInput.closest('.row');
                        group.querySelector('input[name="endereco[]"]').value = data.logradouro || '';
                        group.querySelector('input[name="bairro[]"]').value = data.bairro || '';
                        group.querySelector('input[name="cidade[]"]').value = data.localidade || '';
                        document.querySelector('select[name="estado"]').value = data.uf || '';
                    }
                }).catch(error => console.error('Erro na API ViaCEP:', error));
        }
    }

    // --- FUNÇÕES DE VALIDAÇÃO ---
    function validarCPF(cpf) { 
            cpf = cpf.replace(/[^\d]+/g, ''); // Removes non-numeric characters
            if (cpf == '') return false;
            // Eliminates known invalid CPFs
            if (cpf.length != 11 ||
                cpf == "00000000000" ||
                cpf == "11111111111" ||
                cpf == "22222222222" ||
                cpf == "33333333333" ||
                cpf == "44444444444" ||
                cpf == "55555555555" ||
                cpf == "66666666666" ||
                cpf == "77777777777" ||
                cpf == "88888888888" ||
                cpf == "99999999999")
                return false;
            // Validates 1st digit
            let add = 0;
            for (let i = 0; i < 9; i++)
                add += parseInt(cpf.charAt(i)) * (10 - i);
            let rev = 11 - (add % 11);
            if (rev == 10 || rev == 11)
                rev = 0;
            if (rev != parseInt(cpf.charAt(9)))
                return false;
            // Validates 2nd digit
            add = 0;
            for (let i = 0; i < 10; i++)
                add += parseInt(cpf.charAt(i)) * (11 - i);
            rev = 11 - (add % 11);
            if (rev == 10 || rev == 11)
                rev = 0;
            if (rev != parseInt(cpf.charAt(10)))
                return false;
        return true; }
    function validarCNPJ(cnpj) { 
        cnpj = cnpj.replace(/[^\d]+/g, ''); // Removes non-numeric characters

            if (cnpj == '') {
                return false;
            }

            if (cnpj.length != 14) {
                return false;
            }

            // Eliminates known invalid CNPJs
            if (cnpj == "00000000000000" ||
                cnpj == "11111111111111" ||
                cnpj == "22222222222222" ||
                cnpj == "33333333333333" ||
                cnpj == "44444444444444" ||
                cnpj == "55555555555555" ||
                cnpj == "66666666666666" ||
                cnpj == "77777777777777" ||
                cnpj == "88888888888888" ||
                cnpj == "99999999999999") {
                return false;
            }

            // Validates DVs
            let tamanho = cnpj.length - 2;
            let numeros = cnpj.substring(0, tamanho);
            let digitos = cnpj.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;
            
            for (let i = tamanho; i >= 1; i--) {
                soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
                if (pos < 2) {
                    pos = 9;
                }
            }
            
            let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != parseInt(digitos.charAt(0))) {
                return false;
            }

            tamanho = tamanho + 1;
            numeros = cnpj.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
            
            for (let i = tamanho; i >= 1; i--) {
                soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
                if (pos < 2) {
                    pos = 9;
                }
            }
            
            resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != parseInt(digitos.charAt(1))) {
                return false;
            }
        return true; }
    function validateCpfCnpjInput() {
        var input = $('#cpf_cnpj'), error = $('#cpfCnpjError'), hiddenCpf = $('#hidden_cpf'), hiddenCnpj = $('#hidden_cnpj');
        var valor = input.val().replace(/\D/g, '');
        error.hide(); hiddenCpf.val(''); hiddenCnpj.val('');
        if (valor === '') return true;
        if (valor.length === 11) {
            if (validarCPF(valor)) { hiddenCpf.val(valor); return true; } 
            else { error.text('CPF inválido.').show(); return false; }
        } else if (valor.length === 14) {
            if (validarCNPJ(valor)) { hiddenCnpj.val(valor); return true; } 
            else { error.text('CNPJ inválido.').show(); return false; }
        } else {
            error.text('Documento com tamanho inválido.').show(); return false;
        }
    }

    // --- FUNÇÕES DE MÁSCARA E EVENTOS ---
    function applyMasks() {
        var cpfCnpjMask = function(val) { return val.replace(/\D/g, '').length <= 11 ? '000.000.000-009' : '00.000.000/0000-00'; };
        $('#cpf_cnpj').mask(cpfCnpjMask, { onKeyPress: function(val, e, field, options) { field.mask(cpfCnpjMask.apply({}, arguments), options); } });
        $('.cep-input').mask('00000-000');
        $('.placa-input').mask('SSS-0A00', { translation: { 'S': { pattern: /[A-Za-z]/ }, 'A': { pattern: /[0-9A-Ja-j]/ } }, onKeyPress: function(val, e, field, options){ $(field).mask(val.length > 4 && /[A-Za-z]/.test(val.charAt(4)) ? 'SSS-0A00' : 'SSS-0000', options); } });
        $('.ano-input').mask('0000');
        $('.telefone-input').mask('(00) 00000-0000');
    }

    $(document).ready(function() {
        applyMasks();

        const mainCepInput = document.getElementById('mainCepInput');
        if (mainCepInput) mainCepInput.addEventListener('blur', () => preencherEnderecoPorCep(mainCepInput));
        $('#cpf_cnpj').on('blur', validateCpfCnpjInput);

        // Inicializa estado dos formulários de pagamento
        document.querySelectorAll('form[id^="form_pagamento_"], form[id^="editPagamentoModal"]').forEach(form => {
            const selectMetodo = form.querySelector('select[name="metodo"]');
            if (selectMetodo) {
                toggleOpcaoPagamento({ target: selectMetodo });
                const selectTipo = form.querySelector('select[name="tipo_pagamento"]');
                if (selectTipo) toggleParcelas({ target: selectTipo });
            }
        });

        // Limpeza de máscaras antes de enviar
        $('#editClientForm, #addCarroForm, #updateCarrosForm, #addTelefoneForm').submit(function(event) {
            if (this.id === 'editClientForm' && !validateCpfCnpjInput()) {
                event.preventDefault();
                showCustomAlert('Por favor, corrija o documento (CPF/CNPJ).');
                return;
            }
            $(this).find('.cep-input, .telefone-input').each(function() { $(this).val($(this).val().replace(/\D/g, '')); });
            $(this).find('.placa-input').each(function() { $(this).val($(this).val().replace('-', '').toUpperCase()); });
        });
    });
</script>
</body>
</html>