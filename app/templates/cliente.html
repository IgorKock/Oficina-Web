<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Cliente - OficinaWeb</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* ESTILOS DA ESTRUTURA (BASEADO EM listacliente.txt) */
        :root {
            --sidebar-width: 260px;
            --header-height: 60px;
        }
        
        body {
            background-color: #f0f2f5;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cg fill='%23d3dce3' fill-opacity='0.4'%3E%3Cpath fill-rule='evenodd' d='M0 0h4v4H0V0zm4 4h4v4H4V4z'/%3E%3C/g%3E%3C/svg%3E");
            font-family: 'Poppins', sans-serif;
            padding-top: var(--header-height);
            margin: 0;
            overflow-x: hidden;
        }

        .header {
            height: var(--header-height);
            z-index: 1030;
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1020;
            background-color: #fff;
            padding-top: var(--header-height);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            transition: margin-left 0.3s ease-in-out;
        }
        .sidebar .nav-link {
            color: #555;
            font-weight: 500;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .sidebar .nav-link .bi {
            font-size: 1.2rem;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: #0d6efd;
            background-color: #e9f2ff;
            border-right: 3px solid #0d6efd;
        }

        .main-content {
            padding: 30px;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease-in-out;
        }
        
        @media (max-width: 991.98px) {
            .sidebar {
                margin-left: calc(-1 * var(--sidebar-width));
            }
            .sidebar.active {
                margin-left: 0;
            }
            .main-content {
                margin-left: 0;
            }
        }
        
        /* --- ESTILOS DAS ABAS (ADAPTADOS DE cliente.txt) --- */
        .card-header-tabs .nav-link {
            color: #495057;
            font-weight: 500;
        }
        .card-header-tabs .nav-link.active {
            color: #0d6efd;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
            font-weight: 600;
        }
        .tab-content {
            padding-top: 1rem;
        }

        /* --- CUSTOM ALERT MODAL --- */
        .custom-alert-modal { display: none; position: fixed; z-index: 1055; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .custom-alert-modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-align: center; position: relative; }
        .custom-alert-close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 15px; }
        .custom-alert-close-btn:hover, .custom-alert-close-btn:focus { color: black; text-decoration: none; cursor: pointer; }

        /* --- ESTILOS DE IMPRESS√ÉO --- */
        #print-sections-container .print-section {
            display: none;
        }
    </style>
</head>
<body>

<header class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top header">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" id="menu-toggle">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand fw-bold text-primary" href="#">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Empresa" style="max-width: 40px; height: auto; margin-right: 10px;">
            Oficina Web
        </a>
        <div class="d-flex align-items-center">
            <span class="navbar-text me-3">Bem-vindo, {{ current_user.nome }}!</span>
            <a href="{{ url_for('main.logout') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-box-arrow-right"></i> Sair</a>
        </div>
    </div>
</header>

<aside class="sidebar">
    <div class="p-3"><h5 class="text-muted fw-bold">Menu Principal</h5></div>
    <ul class="nav nav-pills flex-column">
        <li class="nav-item">
            <a href="{{ url_for('main.index') }}" class="nav-link"><i class="bi bi-speedometer2"></i>P√°gina Inicial</a>
        </li>
        <li class="nav-item">
            <a href="{{ url_for('main.client') }}" class="nav-link active"><i class="bi bi-people-fill"></i>Clientes</a>
        </li>
        <li class="nav-item">
            <a href="{{ url_for('main.inventario') }}" class="nav-link"><i class="bi bi-box-seam-fill"></i>Invent√°rio</a>
        </li>
        <li class="nav-item">
            <a href="{{ url_for('main.lista_utilizadores') }}" class="nav-link"><i class="bi bi-people"></i>Usu√°rios</a>
        </li>
    </ul>
</aside>

<main class="main-content">
    <div class="container-fluid">

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4 fw-bold text-dark mb-0"><i class="bi bi-person-lines-fill text-primary me-2"></i> Detalhes do Cliente: {{ cliente.nome }}</h2>
            <a href="{{ url_for('main.client') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-2"></i>Voltar para a Lista</a>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <ul class="nav nav-tabs card-header-tabs" id="clientTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dados-pessoais-tab" data-bs-toggle="tab" data-bs-target="#dados-pessoais-pane" type="button" role="tab" aria-controls="dados-pessoais-pane" aria-selected="true">Dados Pessoais</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="veiculos-tab" data-bs-toggle="tab" data-bs-target="#veiculos-pane" type="button" role="tab" aria-controls="veiculos-pane" aria-selected="false">Ve√≠culos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="telefones-tab" data-bs-toggle="tab" data-bs-target="#telefones-pane" type="button" role="tab" aria-controls="telefones-pane" aria-selected="false">Telefones</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pagamentos-tab" data-bs-toggle="tab" data-bs-target="#pagamentos-pane" type="button" role="tab" aria-controls="pagamentos-pane" aria-selected="false">Pagamentos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="print-tab" data-bs-toggle="tab" data-bs-target="#print-pane" type="button" role="tab" aria-controls="print-pane" aria-selected="false">Imprimir</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="clientTabContent">
                    
                    <!-- Aba: Dados Pessoais -->
                    <div class="tab-pane fade show active" id="dados-pessoais-pane" role="tabpanel" aria-labelledby="dados-pessoais-tab">
                        <form action="{{ url_for('main.update_dados_cliente', cliente_id=cliente.id) }}" method="POST" id="editClientForm">
                            {# üîπ Campo oculto para persistir a aba ativa #}
                            <input type="hidden" name="active_tab" id="active_tab_input_dados_pessoais">

							<div class="row">
								<div class="col-md-6">
									<p class="mb-2"><strong>Nome:</strong> {{ cliente.nome }}</p>
									<p class="mb-2"><strong>Apelido ou Nome Social:</strong> {{ cliente.apelido or "N/A" }}</p>
									<p class="mb-2"><strong>CPF:</strong> {{ cliente.cpf or "N/A" }}</p>
									<p class="mb-2"><strong>CNPJ:</strong> {{ cliente.cnpj or "N/A" }}</p>
								</div>
								<div class="col-md-6">
                                    {# üîπ IN√çCIO: Exibi√ß√£o de M√∫ltiplos Endere√ßos no painel de Dados Pessoais #}
                                    {% if cliente.endereco and cliente.endereco.split(';')|length > 0 %}
                                        {% for i in range(cliente.endereco.split(';')|length) %}
                                            {% set current_endereco = cliente.endereco.split(';')[i].strip() if cliente.endereco and cliente.endereco.split(';')|length > i else 'N/A' %}
                                            {% set current_numero = cliente.numero.split(';')[i].strip() if cliente.numero and cliente.numero.split(';')|length > i else 'N/A' %}
                                            {% set current_complemento = cliente.complemento.split(';')[i].strip() if cliente.complemento and cliente.complemento.split(';')|length > i else 'N/A' %}
                                            {% set current_bairro = cliente.bairro.split(';')[i].strip() if cliente.bairro and cliente.bairro.split(';')|length > i else 'N/A' %}
                                            {% set current_cidade = cliente.cidade.split(';')[i].strip() if cliente.cidade and cliente.cidade.split(';')|length > i else 'N/A' %}
                                            {% set current_cep = cliente.cep.split(';')[i].strip() if cliente.cep and cliente.cep.split(';')|length > i else 'N/A' %}
                                            {% set current_estado = cliente.estado.split(';')[i].strip() if cliente.estado and cliente.estado.split(';')|length > i else 'N/A' %}

                                            <p class="mb-2"><strong>Endere√ßo {{ loop.index }}:</strong> 
                                                {{ current_endereco }}{% if current_numero != 'N/A' %}, {{ current_numero }}{% endif %}
                                                {% if current_complemento != 'N/A' %} ({{ current_complemento }}){% endif %}, 
                                                {{ current_bairro }}, {{ current_cidade }} - {{ current_estado }} {{ current_cep }}
                                            </p>
                                        {% endfor %}
                                    {% else %}
                                        <p class="mb-2"><strong>Endere√ßo:</strong> N/A</p>
                                        <p class="mb-2"><strong>N√∫mero:</strong> N/A</p>
                                        <p class="mb-2"><strong>Complemento:</strong> N/A</p>
                                        <p class="mb-2"><strong>Bairro:</strong> N/A</p>
                                        <p class="mb-2"><strong>Cidade:</strong> N/A</p>
                                        <p class="mb-2"><strong>Estado:</strong> N/A</p>
                                        <p class="mb-2"><strong>CEP:</strong> N/A</p>
                                    {% endif %}
                                    {# üîπ FIM: Exibi√ß√£o de M√∫ltiplos Endere√ßos #}
								</div>
							</div>
							<hr>
							<!-- Bot√µes de A√ß√£o -->
                            <div class="mt-3 d-flex gap-2">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editGeraisModal">
                                    <i class="bi bi-pencil-square me-1"></i> Adicionar / Editar Dados Gerais
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addressModal">
                                    <i class="bi bi-geo-alt-fill me-1"></i> Adicionar / Editar Endere√ßos
                                </button>
                            </div>

							<!-- Caixa de Di√°logo (Modal) de Edi√ß√£o de Dados Gerais -->
							<div class="modal fade" id="editGeraisModal" tabindex="-1" aria-labelledby="editGeraisModalLabel" aria-hidden="true">
								<div class="modal-dialog modal-lg">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="editGeraisModalLabel">Editar Informa√ß√µes Gerais</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">
											<div class="row">
												<div class="col-md-6 mb-3">
													<div class="input-group mb-4">
														<span class="input-group-text"><i class="bi bi-person-fill"></i></span>
														<div class="form-floating flex-grow-1">
															<input type="text" name="apelido" class="form-control" placeholder="Apelido ou Nome Social" value="{{ cliente.apelido or '' }}">
															<label for="apelido">Apelido ou Nome Social</label>
														</div>
													</div>
												</div>
												<div class="col-md-6 mb-3">
													<div class="input-group mb-4">
														<span class="input-group-text"><i class="bi bi-credit-card-2-front-fill"></i></span>
														<div class="form-floating flex-grow-1">
															<input type="text" id="cpf_cnpj" class="form-control" placeholder="CPF ou CNPJ" value="{{ cliente.cpf or cliente.cnpj or '' }}">
															<label for="cpf_cnpj" class="form-label">CPF/CNPJ</label>
															<input type="hidden" name="cpf" id="hidden_cpf" value="{{ cliente.cpf or '' }}">
															<input type="hidden" name="cnpj" id="hidden_cnpj" value="{{ cliente.cnpj or '' }}">
															<span id="cpfCnpjError" class="text-danger small" style="display: none;">Documento inv√°lido.</span>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
											<button type="submit" class="btn btn-primary"><i class="bi bi-check-circle me-2"></i>Atualizar Dados</button>
										</div>
									</div>
								</div>
							</div>

							<!-- Caixa de Di√°logo (Modal) de Endere√ßo -->
							<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
								<div class="modal-dialog modal-lg modal-dialog-scrollable">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="addressModalLabel">Endere√ßos de {{ cliente.nome }}</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">
											<h5 class="mt-4 mb-3">Editar/Adicionar Endere√ßos</h5>
											<div id="enderecos-container">
												<!-- Campos de endere√ßo existentes e novos ser√£o adicionados aqui dinamicamente pelo JS -->
											</div>
											<button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addEnderecoBtn"><i class="bi bi-plus-circle"></i> Adicionar campo de endere√ßo</button>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
											<button type="submit" class="btn btn-primary" form="editClientForm">Salvar Altera√ß√µes</button>
										</div>
									</div>
								</div>
							</div>
						</form>
                    </div>

                    <!-- Aba: Ve√≠culos -->
                    <div class="tab-pane fade" id="veiculos-pane" role="tabpanel" aria-labelledby="veiculos-tab">
                        {# üîπ Campo oculto para persistir a aba ativa #}
                        <input type="hidden" name="active_tab" form="addCarroForm" id="active_tab_input_veiculos">

						<div class="d-flex justify-content-between align-items-center mb-3">
							<h4 class="mb-0">Ve√≠culos do Cliente</h4>
							<button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addCarroModal"><i class="bi bi-plus-circle me-1"></i>Adicionar Ve√≠culo</button>
						</div>
						
						{% if carros %}
							{% for carro in carros %}
								<div class="card mb-3">
									<div class="card-header d-flex justify-content-between align-items-center">
										<h5 class="mb-0">{{ carro.marca }} {{ carro.modelo }} ({{ carro.ano }}) - {{ carro.placa }}</h5>
										<div>
											<button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#updateCarroModal{{ carro.id }}"><i class="bi bi-pencil-fill"></i></button>
										</div>
									</div>
									<div class="card-body">
										<p><strong>Motor:</strong> {{ carro.motor or 'N/A' }} | <strong>Quilometragem:</strong> {{ carro.quilometragem or 'N/A' }} KMs</p>
										
										<h6 class="mt-4">Hist√≥rico de Servi√ßos</h6>
										{% if carro.historicos %}
											<table class="table table-sm table-striped table-hover">
												<thead>
													<tr>
														<th>Data e Hora</th>
														<th>Descri√ß√£o do Servi√ßo</th>
														<th class="text-end">A√ß√µes</th>
													</tr>
												</thead>
												<tbody>
													{% for historico in carro.historicos %}
													<tr>
														<td>{{ historico.data_local.strftime('%d/%m/%Y %H:%M') if historico.data_local else '' }}</td>
														<td>{{ historico.descricao }}</td>
														<td class="text-end">
															<button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editHistoricoModal{{ historico.id }}"><i class="bi bi-pencil"></i></button>
															<form action="{{ url_for('main.delete_historico', id=historico.id) }}" method="POST" class="d-inline">
                                                                {# üîπ Campo oculto para persistir a aba ativa #}
                                                                <input type="hidden" name="active_tab" value="veiculos-pane">
																<button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza?');"><i class="bi bi-trash"></i></button>
															</form>
														</td>
													</tr>
													{% endfor %}
												</tbody>
											</table>
										{% else %}
											<p class="text-muted">Nenhum hist√≥rico de servi√ßo registrado.</p>
										{% endif %}
										
										<div class="mt-3">
											<form action="/add_historico/{{ carro.id }}" method="POST" class="row gx-2 align-items-end">
                                                {# üîπ Campo oculto para persistir a aba ativa #}
                                                <input type="hidden" name="active_tab" value="veiculos-pane">
                                                <h4 class="md-6 mb-3">Adicionar novo hist√≥rico de servi√ßos</h4>
												<div class="col md-6 mb-3">
                                                    <div class="input-group mb-4">
                                                    <span class="input-group-text"><i class="bi bi-tag-fill"></i></span>
                                                        <div class="form-floating flex-grow-1">													    
													        <input type="text" name="descricao" placeholder="Descri√ß√£o do servi√ßo" class="form-control form-control-sm" required>
                                                            <label for="descricao_hist" class="form-label small">Descri√ß√£o</label>
                                                        </div>
                                                    </div>
                                                </div>
												<div class="col md-6 mb-3">
                                                    <div class="input-group mb-4">
                                                    <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                                        <div class="form-floating flex-grow-1">														
													        <input type="date" name="data" class="form-control form-control-sm" required>
                                                            <label for="data_hist" class="form-label small">Data</label>
												        </div>
                                                    </div>
                                                </div>
												<div class="col-auto">
													<button type="submit" class="btn btn-primary btn-sm">Adicionar</button>
												</div>
											</form>
										</div>
									</div>
								</div>

								<!-- Modal para Editar Carro -->
								<div class="modal fade" id="updateCarroModal{{ carro.id }}" tabindex="-1" aria-hidden="true">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="modal-title">Editar Ve√≠culo</h5>
												<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
											</div>
											<form action="{{ url_for('main.update_carros', cliente_id=cliente.id) }}" method="POST">
                                                {# üîπ Campo oculto para persistir a aba ativa #}
                                                <input type="hidden" name="active_tab" value="veiculos-pane">
												<div class="modal-body">
													<input type="hidden" name="carro_id" value="{{ carro.id }}">
													<div class="col mb-3">
                                                        <div class="input-group mb-4">
                                                        <span class="input-group-text"><i class="bi bi-car-front-fill"></i></span>
                                                            <div class="form-floating flex-grow-1">                                                                  
                                                                <input type="text" name="marca_{{ carro.id }}" class="form-control" value="{{ carro.marca }}" required>
                                                                <label class="form-label">Marca</label>
                                                            </div>
                                                        </div>
													</div>                                                                                                     
													<div class="col mb-3">
                                                        <div class="input-group mb-4">
                                                            <span class="input-group-text"><i class="bi bi-car-front-fill"></i></span>
                                                            <div class="form-floating flex-grow-1">                                                               
                                                                <input type="text" name="modelo_{{ carro.id }}" class="form-control" value="{{ carro.modelo }}" required>
                                                                <label class="form-label">Modelo</label>
                                                            </div>
                                                        </div>
                                                    </div>
													<div class="col mb-3">
                                                        <div class="input-group mb-4">
                                                            <span class="input-group-text"><i class="bi bi-car-front"></i></span>
                                                            <div class="form-floating flex-grow-1">                                                                
                                                                <input type="text" name="motor_{{ carro.id }}" class="form-control" value="{{ carro.motor }}">
                                                                <label class="form-label">Motor</label>
                                                            </div>
                                                        </div>
                                                    </div>
													<div class="col mb-3">
                                                        <div class="input-group mb-4">
                                                            <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                                            <div class="form-floating flex-grow-1">                                                                
                                                                <input type="number" name="ano_{{ carro.id }}" class="form-control ano-input" value="{{ carro.ano }}">
                                                                <label class="form-label">Ano</label>
                                                            </div>
                                                        </div>
                                                    </div>
													<div class="col mb-3">
                                                        <div class="input-group mb-4">
                                                            <span class="input-group-text"><i class="bi bi-tags-fill"></i></span>
                                                            <div class="form-floating flex-grow-1">                                                                
                                                                <input type="text" name="placa_{{ carro.id }}" class="form-control placa-input" value="{{ carro.placa }}" required>
                                                                <label class="form-label">Placa</label>
                                                            </div>
                                                        </div>
                                                    </div>
													<div class="col mb-3">
                                                        <div class="input-group mb-4">
                                                            <span class="input-group-text"><i class="bi bi-speedometer2"></i></span>
                                                            <div class="form-floating flex-grow-1">                                                                
                                                                <input type="number" name="quilometragem_{{ carro.id }}" class="form-control" value="{{ carro.quilometragem }}">
                                                                <label class="form-label">Quilometragem</label>
                                                            </div>
                                                        </div>
                                                    </div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
													<button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
												</div>
											</form>
										</div>
									</div>
								</div>

								<!-- Modais para Editar Hist√≥rico (um para cada hist√≥rico) -->
								{% for historico in carro.historicos %}
								<div class="modal fade" id="editHistoricoModal{{ historico.id }}" tabindex="-1" aria-hidden="true">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header"><h5 class="modal-title">Editar Hist√≥rico de servi√ßo</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
											<form action="{{ url_for('main.edit_historico', id=historico.id) }}" method="POST">
                                                {# üîπ Campo oculto para persistir a aba ativa #}
                                                <input type="hidden" name="active_tab" value="veiculos-pane">
												<div class="modal-body">
													<div class="col mb-3">
                                                        <div class="input-group mb-4">
                                                        <span class="input-group-text"><i class="bi bi-tag-fill"></i></span>
                                                            <div class="form-floating flex-grow-1">                                                                
                                                                <input type="text" class="form-control" name="descricao" value="{{ historico.descricao }}" required>
                                                                <label class="form-label">Descri√ß√£o</label>
                                                            </div>
                                                        </div>
                                                    </div>
													<div class="col mb-3">
                                                        <div class="input-group mb-4">
                                                            <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                                            <div class="form-floating flex-grow-1">                                                                
                                                                <input type="date" class="form-control" name="data" value="{{ historico.data_local.strftime('%Y-%m-%d') if historico.data_local else '' }}" required>
                                                                <label class="form-label">Data</label>
                                                            </div>
                                                        </div>
                                                    </div>  
												</div>
												<div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
											</form>
										</div>
									</div>
								</div>
								{% endfor %}
							{% endfor %}
						{% else %}
							<div class="text-center p-4 border rounded bg-light">
								<p class="mb-0 text-muted">Nenhum ve√≠culo registrado para este cliente.</p>
							</div>
						{% endif %}
                    </div>

                    <!-- Aba: Telefones -->
                    <div class="tab-pane fade" id="telefones-pane" role="tabpanel" aria-labelledby="telefones-tab">
                        {# üîπ Campo oculto para persistir a aba ativa #}
                        <input type="hidden" name="active_tab" form="addTelefoneForm" id="active_tab_input_telefones">

						<h4 class="mb-3">Telefones do Cliente</h4>                       
						{% if telefones %}
							<div class="d-flex flex-wrap gap-2 mb-4">
								{% for telefone in telefones %}
									<span class="d-inline-flex align-items-center py-1 px-2 border rounded bg-light text-dark">
										<i class="bi bi-phone-fill me-2 text-secondary"></i>
										<span class="fw-medium" style="font-size: 0.9rem;">{{ telefone.numero }}</span>
										<form action="{{ url_for('main.delete_telefone', telefone_id=telefone.id) }}" method="POST" class="d-inline ms-2">
                                            {# üîπ Campo oculto para persistir a aba ativa #}
                                            <input type="hidden" name="active_tab" value="telefones-pane">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza que deseja remover este telefone?');" title="Remover"><i class="bi bi-trash"></i></button>
										</form>
									</span>
								{% endfor %}
							</div>
						{% else %}
							<p class="text-muted">Nenhum telefone registrado.</p>
						{% endif %}
						<hr>
						<h5 class="mt-4 mb-3">Adicionar Novos Telefones</h5>
						<form action="{{ url_for('main.add_telefone', cliente_id=cliente.id) }}" method="POST" id="addTelefoneForm">
							<div id="telefones-container-add">
								<div class="input-group mb-4">                                    
                                    <span class="input-group-text"><i class="bi bi-phone-fill"></i></span>
                                    <div class="form-floating flex-grow-1">								
									    <input type="text" name="numeros[]" class="form-control telefone-input" placeholder="Digite o Telefone" required>
                                        <label class="form-label">Telefone</label>
                                    </div>
                                    <button class="btn btn-outline-secondary" type="button" onclick="adicionarCampoTelefone()"><i class="bi bi-plus-circle"></i></button>
								</div>
							</div>
							<button type="submit" class="btn btn-primary mt-2">Salvar Telefone(s)</button>
						</form>
                    </div>

                    <!-- Aba: Pagamentos -->
                    <div class="tab-pane fade" id="pagamentos-pane" role="tabpanel" aria-labelledby="pagamentos-tab">
						<h4 class="mb-3">Pagamentos do Cliente</h4>
						{% if pagamentos %}
							<div class="table-responsive">
								<table class="table table-hover align-middle">
									<thead class="table-light">
										<tr>
											<th>Ve√≠culo</th>
											<th>Servi√ßo</th>
											<th>Data e Hora</th>
											<th>Valor (R$)</th>
											<th>M√©todo</th>
											<th class="text-end">A√ß√µes</th>
										</tr>
									</thead>
									<tbody>
										{% for pagamento in pagamentos %}
										<tr>
											<td>{{ pagamento.carro.marca }} {{ pagamento.carro.modelo }} {{ pagamento.carro.ano }}</td>
											<td>{{ pagamento.historico.descricao }}</td>
											<td>{{ pagamento.data_local.strftime('%d/%m/%Y %H:%M') if pagamento.data_local else '' }}</td>
											<td>R$ {{ "%.2f"|format(pagamento.valor) }}</td>
											<td>{{ pagamento.metodo }} {% if pagamento.tipo_pagamento == 'Parcelado' %}({{ pagamento.parcelas }}x){% endif %}  {% if not pagamento.tipo_pagamento == 'Parcelado' %} ({{ "A vista" }}) {% endif %}</td>
											<td class="text-end">
												<button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editPagamentoModal{{ pagamento.id }}"><i class="bi bi-pencil"></i></button>
												<form action="{{ url_for('main.delete_pagamento', id=pagamento.id) }}" method="POST" class="d-inline">
                                                    {# üîπ Campo oculto para persistir a aba ativa #}
                                                    <input type="hidden" name="active_tab" value="pagamentos-pane">
													<button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza?');"><i class="bi bi-trash"></i></button>
												</form>
											</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						{% else %}
							<p class="text-muted">Nenhum pagamento registrado.</p>
						{% endif %}
						<hr>
						<h5 class="mt-4 mb-3">Registrar Novo Pagamento</h5>
						{% set servicos_sem_pagamento = namespace(count=0) %}
						{% for carro in carros %}
							{% for historico in carro.historicos %}
								{% if not historico.tem_pagamento %}
									{% set servicos_sem_pagamento.count = servicos_sem_pagamento.count + 1 %}
									<form id="form_pagamento_{{ historico.id }}" action="{{ url_for('main.add_pagamento', cliente_id=cliente.id, carro_id=carro.id, historico_id=historico.id) }}" method="POST" class="mb-4 p-3 border rounded bg-light">
                                        {# üîπ Campo oculto para persistir a aba ativa #}
                                        <input type="hidden" name="active_tab" value="pagamentos-pane">
										<p class="fw-bold">Para: {{ historico.descricao }} ({{ carro.marca }} {{ carro.modelo }})</p>
                                        <div class="row">
											<div class="col-md-6 mb-3">
                                                <div class="input-group mb-4">
                                                    <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                                    <div class="form-floating flex-grow-1">
                                                        <input type="text" class="form-control money-input" name="valor" required>
                                                        <label class="form-label">Valor (R$)</label>
                                                    </div>
                                                </div>
                                            </div>
											<div class="col-md-6 mb-3">
                                                <div class="input-group mb-4">
                                                    <span class="input-group-text"><i class="bi bi-credit-card-2-front-fill"></i></span>
                                                    <div class="form-floating flex-grow-1">
                                                        <select name="metodo" class="form-select" required onchange="toggleOpcaoPagamento(this)">
                                                            <option value="Dinheiro">Dinheiro</option>
                                                            <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                                                            <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                                                            <option value="Pix">Pix</option>
                                                        </select>
                                                        <label class="form-label">M√©todo</label>
                                                    </div>
                                                </div>
                                            </div>
											<div class="col-md-6 mb-3 opcaoCartao" style="display: none;">
												<div class="row">
													<div class="col-md-6 mb-3">
                                                        <div class="input-group mb-4">
                                                            <span class="input-group-text"><i class="bi bi-credit-card-2-front-fill"></i></span>                                          
                                                                <div class="form-floating flex-grow-1"> 
                                                                <select name="tipo_pagamento" class="form-select" onchange="toggleParcelas(this)">
                                                                    <option value="√Ä vista">√Ä vista</option>
                                                                    <option value="Parcelado">Parcelado</option>
                                                                </select>
                                                                <label class="form-label">Tipo</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                                                                    
													<div class="col-md-6 mb-3 opcaoParcelado" style="display: none;">
                                                        <div class="input-group mb-4">
                                                            <span class="input-group-text"><i class="bi bi-credit-card-2-front-fill"></i></span>
                                                                <div class="form-floating flex-grow-1">
                                                                    <input type="number" name="parcelas" min="1" max="12" class="form-control">
                                                                    <label class="form-label">Parcelas</label>
                                                                </div>
                                                            </div>
                                                        </div>
												</div>
                                            </div>
											<div class="col-md-6 mb-3">
                                                <div class="input-group mb-4">
                                                    <span class="input-group-text"><i class="bi bi-calendar-fill"></i></span>
                                                    <div class="form-floating flex-grow-1">                                            
                                                        <input type="date" name="data_pagamento" class="form-control" required>
                                                        <label class="form-label">Data</label>
                                                    </div>
                                                </div>
                                            </div>
											<div class="col-md-12">
                                                <button type="submit" class="btn btn-primary">Registrar</button>
                                            </div>
										</div>
									</form>
								{% endif %}
							{% endfor %}
						{% endfor %}
						{% if servicos_sem_pagamento.count == 0 and carros %}
							<p class="text-success">Todos os servi√ßos j√° possuem pagamentos registrados.</p>
						{% endif %}

						<!-- Modais para editar pagamentos -->
						{% for pagamento in pagamentos %}
						<div class="modal fade" id="editPagamentoModal{{ pagamento.id }}" tabindex="-1" aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header"><h5 class="modal-title">Editar Pagamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
									<form action="{{ url_for('main.edit_pagamento', id=pagamento.id) }}" method="POST">
                                        {# üîπ Campo oculto para persistir a aba ativa #}
                                        <input type="hidden" name="active_tab" value="pagamentos-pane">
										<div class="modal-body">
											<div class="col-md-6 mb-3">
                                                <div class="input-group mb-4">
                                                    <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                                    <div class="form-floating flex-grow-1">                                                        
                                                        <input type="text" class="form-control money-input" name="valor" value="{{ "%.2f"|format(pagamento.valor) }}" required>
                                                        <label class="form-label">Valor (R$)</label>
                                                    </div>
                                                </div>
                                            </div>
											<div class="col-md-6 mb-3">
                                                <div class="input-group mb-4">
                                                    <span class="input-group-text"><i class="bi bi-credit-card-2-front-fill"></i></span>
                                                    <div class="form-floating flex-grow-1">                                                
                                                        <select class="form-select" name="metodo" required onchange="toggleOpcaoPagamento(this)">
                                                            <option value="Dinheiro" {% if pagamento.metodo == 'Dinheiro' %}selected{% endif %}>Dinheiro</option>
                                                            <option value="Cart√£o de Cr√©dito" {% if pagamento.metodo == 'Cart√£o de Cr√©dito' %}selected{% endif %}>Cart√£o de Cr√©dito</option>
                                                            <option value="Cart√£o de D√©bito" {% if pagamento.metodo == 'Cart√£o de D√©bito' %}selected{% endif %}>Cart√£o de D√©bito</option>
                                                            <option value="Pix" {% if pagamento.metodo == 'Pix' %}selected{% endif %}>Pix</option>
                                                        </select>
                                                        <label class="form-label">M√©todo</label>
                                                    </div>
                                                </div>
                                            </div>
											<div class="opcaoCartao" {% if pagamento.metodo != 'Cart√£o de Cr√©dito' %}style="display: none;"{% endif %}>
												<div class="col-md-6 mb-3">
                                                    <div class="input-group mb-4">
                                                        <span class="input-group-text"><i class="bi bi-credit-card-2-front-fill"></i></span>                                          
                                                        <div class="form-floating flex-grow-1">                                                   
                                                            <select class="form-select" name="tipo_pagamento" onchange="toggleParcelas(this)">
                                                                <option value="√Ä vista" {% if pagamento.tipo_pagamento == '√Ä vista' %}selected{% endif %}>√Ä vista</option>
                                                                <option value="Parcelado" {% if pagamento.tipo_pagamento == 'Parcelado' %}selected{% endif %}>Parcelado</option>
                                                            </select>
                                                            <label class="form-label">Tipo</label>
                                                        </div>
                                                    </div>
                                                </div>
												<div class="col-md-6 mb-3 opcaoParcelado" {% if pagamento.tipo_pagamento != 'Parcelado' %}style="display: none;"{% endif %}>
                                                    <div class="input-group mb-4">
                                                        <span class="input-group-text"><i class="bi bi-credit-card-2-front-fill"></i></span>
                                                        <div class="form-floating flex-grow-1">                                                            
                                                            <input type="number" class="form-control" name="parcelas" min="1" max="12" value="{{ pagamento.parcelas or '' }}">
                                                            <label class="form-label">Parcelas</label>
                                                        </div>
                                                    </div>
                                                </div>
											</div>
										</div>
										<div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
									</form>
								</div>
							</div>
						</div>
						{% endfor %}
                    </div>

                    <!-- Aba: Imprimir -->
                    <div class="tab-pane fade" id="print-pane" role="tabpanel" aria-labelledby="print-tab">
						<h4 class="mb-3">Sele√ß√£o para Impress√£o</h4>
						<form id="print-form" class="mb-3">
							<div class="form-check"><input type="checkbox" id="checkbox-print-dados-pessoais" class="form-check-input"><label class="form-check-label" for="checkbox-print-dados-pessoais">Dados Pessoais</label></div>
							<div class="form-check"><input type="checkbox" id="checkbox-print-telefones" class="form-check-input"><label class="form-check-label" for="checkbox-print-telefones">Telefones</label></div>
							<div class="form-check"><input type="checkbox" id="checkbox-print-veiculos" class="form-check-input"><label class="form-check-label" for="checkbox-print-veiculos">Ve√≠culos e Hist√≥ricos</label></div>
                            <div class="form-check"><input type="checkbox" id="checkbox-print-pagamentos" class="form-check-input"><label class="form-check-label" for="checkbox-print-pagamentos">Pagamentos</label></div>
						</form>
						<button type="button" class="btn btn-primary" onclick="imprimirSelecionados()"><i class="bi bi-printer-fill me-2"></i>Imprimir Selecionados</button>
						
						<!-- Conte√∫do oculto para impress√£o -->
						<div id="print-sections-container">
							<div id="print-section-dados-pessoais" class="print-section">
								<h4>Dados Pessoais</h4>
								<p><strong>Nome:</strong> {{ cliente.nome }}</p>
								<p><strong>CPF/CNPJ:</strong> <span id="print-cpf-cnpj">{{ cliente.cpf or cliente.cnpj or "N/A" }}</span></p>
                                {# üîπ IN√çCIO: Exibi√ß√£o de M√∫ltiplos Endere√ßos para Impress√£o #}
                                {% if cliente.endereco and cliente.endereco.split(';')|length > 0 %}
                                    {% for i in range(cliente.endereco.split(';')|length) %}
                                        {% set current_endereco = cliente.endereco.split(';')[i].strip() if cliente.endereco and cliente.endereco.split(';')|length > i else 'N/A' %}
                                        {% set current_numero = cliente.numero.split(';')[i].strip() if cliente.numero and cliente.numero.split(';')|length > i else 'N/A' %}
                                        {% set current_complemento = cliente.complemento.split(';')[i].strip() if cliente.complemento and cliente.complemento.split(';')|length > i else 'N/A' %}
                                        {% set current_bairro = cliente.bairro.split(';')[i].strip() if cliente.bairro and cliente.bairro.split(';')|length > i else 'N/A' %}
                                        {% set current_cidade = cliente.cidade.split(';')[i].strip() if cliente.cidade and cliente.cidade.split(';')|length > i else 'N/A' %}
                                        {% set current_cep = cliente.cep.split(';')[i].strip() if cliente.cep and cliente.cep.split(';')|length > i else 'N/A' %}
                                        {% set current_estado = cliente.estado.split(';')[i].strip() if cliente.estado and cliente.estado.split(';')|length > i else 'N/A' %}

                                        <p class="mb"><strong>Endere√ßo {{ loop.index }}:</strong> 
                                            {{ current_endereco }}{% if current_numero != 'N/A' %}, {{ current_numero }}{% endif %}
                                            {% if current_complemento != 'N/A' %} ({{ current_complemento }}){% endif %}, 
                                            {{ current_bairro }}, {{ current_cidade }} - {{ current_estado }} {{ current_cep }}
                                        </p>
                                    {% endfor %}
                                {% else %}
                                    <p class="mb"><strong>Endere√ßo:</strong> N/A</p>
                                    <p class="mb"><strong>N√∫mero:</strong> N/A</p>
                                    <p class="mb"><strong>Complemento:</strong> N/A</p>
                                    <p class="mb"><strong>Bairro:</strong> N/A</p>
                                    <p class="mb"><strong>Cidade:</strong> N/A</p>
                                    <p class="mb"><strong>Estado:</strong> N/A</p>
                                    <p class="mb"><strong>CEP:</strong> N/A</p>
                                {% endif %}
                                {# üîπ FIM: Exibi√ß√£o de M√∫ltiplos Endere√ßos para Impress√£o #}
							</div>
							<div id="print-section-telefones" class="print-section">
								<h4>Telefones</h4>
								{% for telefone in telefones %}<p>{{ telefone.numero }}</p>{% endfor %}
							</div>
							<div id="print-section-veiculos" class="print-section">
								<h4>Ve√≠culos e Hist√≥ricos</h4>
								{% for carro in carros %}
									<div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ccc;">
										<p><strong>Ve√≠culo:</strong> {{ carro.marca }} {{ carro.modelo }} ({{ carro.ano }}) - Placa: {{ carro.placa }}</p>
										<p><strong>Servi√ßos:</strong></p>
                                        <ul>{% for historico in carro.historicos %}<li><strong>{{ historico.data_local.strftime('%d/%m/%Y %H:%M') }}:</strong> {{ historico.descricao }}</li>{% endfor %}</ul>
									</div>
								{% endfor %}
							</div>
							<div id="print-section-pagamentos" class="print-section">
								<h4>Pagamentos</h4>
								<table class="table table-sm">
									<thead><tr><th>Data e Hora</th><th>Servi√ßo</th><th>Valor</th><th>M√©todo</th></tr></thead>
									<tbody>
									{% for pagamento in pagamentos %}
										<tr>
											<td>{{ pagamento.data_local.strftime('%d/%m/%Y %H:%M') }}</td>
											<td>{{ pagamento.historico.descricao }}</td>
											<td>R$ {{ "%.2f"|format(pagamento.valor) }}</td>
											<td>{{ pagamento.metodo }} {% if pagamento.tipo_pagamento == 'Parcelado' %}({{ pagamento.parcelas }}x){% endif %}  {% if not pagamento.tipo_pagamento == 'Parcelado' %} ({{ "A vista" }}) {% endif %}</td>
										</tr>
									{% endfor %}
									</tbody>
								</table>
							</div>
						</div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<!-- Modal para Adicionar Novo Carro -->
<div class="modal fade" id="addCarroModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Novo Ve√≠culo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('main.add_carros', cliente_id=cliente.id) }}" method="POST" id="addCarroForm">
                {# üîπ Campo oculto para persistir a aba ativa #}
                <input type="hidden" name="active_tab" value="veiculos-pane">
                <div class="modal-body">
                    <div class="col mb-3">
                        <div class="input-group mb-4">
                            <span class="input-group-text"><i class="bi bi-car-front-fill"></i></span>
                            <div class="form-floating flex-grow-1">
								<input type="text" name="marca[]" class="form-control" required>                        
                                <label class="form-label">Marca</label>
                            </div>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="input-group mb-4">
                            <span class="input-group-text"><i class="bi bi-car-front-fill"></i></span>
                            <div class="form-floating flex-grow-1">                                
                                <input type="text" name="modelo[]" class="form-control" required>
                                <label class="form-label">Modelo</label>
                            </div>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="input-group mb-4">
                            <span class="input-group-text"><i class="bi bi-car-front"></i></span>
                            <div class="form-floating flex-grow-1">                                
                                <input type="text" name="motor[]" class="form-control">
                                <label class="form-label">Motor</label>
                            </div>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="input-group mb-4">
                            <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                            <div class="form-floating flex-grow-1">                                
                                <input type="number" name="ano[]" class="form-control ano-input">
                                <label class="form-label">Ano</label>
                            </div>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="input-group mb-4">
                            <span class="input-group-text"><i class="bi bi-tags-fill"></i></span>
                            <div class="form-floating flex-grow-1">                                    
                                <input type="text" name="placa[]" class="form-control placa-input" required>
                                <label class="form-label">Placa</label>
                            </div>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="input-group mb-4">
                            <span class="input-group-text"><i class="bi bi-speedometer2"></i></span>
                            <div class="form-floating flex-grow-1">                                
                                <input type="number" name="quilometragem[]" class="form-control">
                                <label class="form-label">Quilometragem</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Ve√≠culo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Custom Alert Modal HTML -->
<div id="customAlertModal" class="custom-alert-modal">
    <div class="custom-alert-modal-content">
        <span class="custom-alert-close-btn">√ó</span>
        <p id="customAlertMessage"></p>
        <button class="btn btn-primary" onclick="closeCustomAlert()">OK</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    // --- L√ìGICA DO MENU LATERAL (DE listacliente.txt) ---
    document.addEventListener("DOMContentLoaded", function() {
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        if (menuToggle) {
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });
        }
    });

    // --- FUN√á√ïES DE ALERTA ---
    function showCustomAlert(message) {
        document.getElementById('customAlertMessage').innerText = message;
        document.getElementById('customAlertModal').style.display = 'flex';
    }
    function closeCustomAlert() {
        document.getElementById('customAlertModal').style.display = 'none';
    }
    document.querySelector('.custom-alert-close-btn').onclick = closeCustomAlert;
    window.onclick = function(event) {
        if (event.target == document.getElementById('customAlertModal')) closeCustomAlert();
    }

    // --- FUN√á√ïES DE MANIPULA√á√ÉO DO FORMUL√ÅRIO ---
    function adicionarCampoTelefone() {
        const container = document.getElementById('telefones-container-add');
        const newDiv = document.createElement('div');
        newDiv.classList.add('input-group', 'mb-4');
        newDiv.innerHTML = `
        <div class="input-group mb-4">                                    
            <span class="input-group-text"><i class="bi bi-phone-fill"></i></span>
            <div class="form-floating flex-grow-1">
                <input type="text" name="numeros[]" class="form-control telefone-input" placeholder="Telefone adicional" required>               
                <label class="form-label">Telefone Extra</label>
            </div>
             <button type="button" class="btn btn-outline-danger" onclick="this.closest('.input-group').remove();"><i class="bi bi-trash"></i></button>
        </div>
        `;
        container.appendChild(newDiv);
        $(newDiv).find('.telefone-input').mask('(00) 00000-0000');
    }

    // üîπ Fun√ß√£o para adicionar campo de endere√ßo, restaurando o layout antigo
    function adicionarCampoEndereco(cep = '', endereco = '', numero = '', complemento = '', bairro = '', cidade = '', estado = '', isPrincipal = false) {
        const container = document.getElementById('enderecos-container');
        const index = container.children.length; // Novo √≠ndice para o r√°dio button
        const newDiv = document.createElement('div');
        newDiv.classList.add('endereco-group', 'mb-3', 'border', 'p-3', 'rounded', 'bg-light', 'position-relative');
        
        // Bot√£o de remover s√≥ aparece se n√£o for o primeiro endere√ßo
        let removeButton = index === 0 ? '' : '<button type="button" class="btn-close position-absolute top-0 end-0 m-2 remove-endereco-btn" aria-label="Close"></button>';
        
        newDiv.innerHTML = `
            ${removeButton}
            <div class="mb-2">
                <p class="mb"><strong>Endere√ßo</strong></p>                
            </div>
            <div class="row g-2"> 
                <div class="col-md-6 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-signpost-split-fill"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" name="cep[]" class="form-control cep-input" placeholder="CEP" value="${cep}">
                            <label class="form-label">CEP</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-geo-alt-fill"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" name="endereco[]" class="form-control" placeholder="Endere√ßo" value="${endereco}">
                            <label class="form-label">Endere√ßo</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-hash"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" name="numero[]" class="form-control" placeholder="N√∫mero" value="${numero}">
                            <label class="form-label">N√∫mero</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-house"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" name="complemento[]" class="form-control" placeholder="Complemento" value="${complemento}">
                            <label class="form-label">Complemento</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-signpost-split"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" name="bairro[]" class="form-control" placeholder="Bairro" value="${bairro}">
                            <label class="form-label">Bairro</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-pin-map-fill"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input type="text" name="cidade[]" class="form-control" placeholder="Cidade" value="${cidade}">
                            <label class="form-label">Cidade</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-pin-map-fill"></i></span>
                        <div class="form-floating flex-grow-1">
                            <select name="estado[]" class="form-select">
                                <option value="">Selecione o Estado...</option>
                                <option value="AC" ${estado == 'AC' ? 'selected' : ''}>Acre</option>
                                <option value="AL" ${estado == 'AL' ? 'selected' : ''}>Alagoas</option>
                                <option value="AP" ${estado == 'AP' ? 'selected' : ''}>Amap√°</option>
                                <option value="AM" ${estado == 'AM' ? 'selected' : ''}>Amazonas</option>
                                <option value="BA" ${estado == 'BA' ? 'selected' : ''}>Bahia</option>
                                <option value="CE" ${estado == 'CE' ? 'selected' : ''}>Cear√°</option>
                                <option value="DF" ${estado == 'DF' ? 'selected' : ''}>Distrito Federal</option>
                                <option value="ES" ${estado == 'ES' ? 'selected' : ''}>Esp√≠rito Santo</option>
                                <option value="GO" ${estado == 'GO' ? 'selected' : ''}>Goi√°s</option>
                                <option value="MA" ${estado == 'MA' ? 'selected' : ''}>Maranh√£o</option>
                                <option value="MT" ${estado == 'MT' ? 'selected' : ''}>Mato Grosso</option>
                                <option value="MS" ${estado == 'MS' ? 'selected' : ''}>Mato Grosso do Sul</option>
                                <option value="MG" ${estado == 'MG' ? 'selected' : ''}>Minas Gerais</option>
                                <option value="PA" ${estado == 'PA' ? 'selected' : ''}>Par√°</option>
                                <option value="PB" ${estado == 'PB' ? 'selected' : ''}>Para√≠ba</option>
                                <option value="PR" ${estado == 'PR' ? 'selected' : ''}>Paran√°</option>
                                <option value="PE" ${estado == 'PE' ? 'selected' : ''}>Pernambuco</option>
                                <option value="PI" ${estado == 'PI' ? 'selected' : ''}>Piau√≠</option>
                                <option value="RJ" ${estado == 'RJ' ? 'selected' : ''}>Rio de Janeiro</option>
                                <option value="RN" ${estado == 'RN' ? 'selected' : ''}>Rio Grande do Norte</option>
                                <option value="RS" ${estado == 'RS' ? 'selected' : ''}>Rio Grande do Sul</option>
                                <option value="RO" ${estado == 'RO' ? 'selected' : ''}>Rond√¥nia</option>
                                <option value="RR" ${estado == 'RR' ? 'selected' : ''}>Roraima</option>
                                <option value="SC" ${estado == 'SC' ? 'selected' : ''}>Santa Catarina</option>
                                <option value="SP" ${estado == 'SP' ? 'selected' : ''}>S√£o Paulo</option>
                                <option value="SE" ${estado == 'SE' ? 'selected' : ''}>Sergipe</option>
                                <option value="TO" ${estado == 'TO' ? 'selected' : ''}>Tocantins</option>
                            </select>
                            <label class="form-label">Estado</label>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newDiv);
        const newCepInput = newDiv.querySelector('.cep-input');
        $(newCepInput).mask('00000-000');
        newCepInput.addEventListener('blur', () => preencherEnderecoPorCep(newCepInput));
        updateEnderecoRemoveButtons(); // Atualiza a visibilidade dos bot√µes de remover
    }

    // üîπ Atualiza a visibilidade dos bot√µes de remover endere√ßo
    function updateEnderecoRemoveButtons() {
        const removeButtons = document.querySelectorAll('.endereco-group .remove-endereco-btn');
        if (removeButtons.length === 1) {
            removeButtons[0].style.display = 'none';
        } else {
            removeButtons.forEach(button => button.style.display = 'block');
        }
    }

    // üîπ Atualiza os nomes dos r√°dio buttons para garantir que apenas um seja selecion√°vel
    function updatePrincipalRadioNames() {
        const radioButtons = document.querySelectorAll('.is-principal-radio');
        radioButtons.forEach((radio, index) => {
            radio.id = `endereco_principal_${index}`;
            radio.value = index; // O valor √© o √≠ndice do array, √∫til para o backend
            radio.nextElementSibling.setAttribute('for', `endereco_principal_${index}`);
        });
    }

    function toggleOpcaoPagamento(selectElement) {
        const form = selectElement.closest("form") || selectElement.closest(".modal-body");
        const opcaoCartao = form.querySelector(".opcaoCartao");
        if (selectElement.value === "Cart√£o de Cr√©dito") {
            opcaoCartao.style.display = "block";
        } else {
            opcaoCartao.style.display = "none";
            const opcaoParcelado = form.querySelector(".opcaoParcelado");
            if (opcaoParcelado) opcaoParcelado.style.display = "none";
        }
    }

    function toggleParcelas(selectElement) {
        const form = selectElement.closest("form") || selectElement.closest(".modal-body");
        const opcaoParcelado = form.querySelector(".opcaoParcelado");
        if (selectElement.value === "Parcelado") {
            opcaoParcelado.style.display = "block";
        } else {
            opcaoParcelado.style.display = "none";
        }
    }

    // üîπ Fun√ß√£o para formatar CPF/CNPJ para impress√£o (sem censura)
    function formatCpfCnpjForPrint(value) {
        if (!value) return '';
        const cleanedValue = value.replace(/\D/g, ''); // Remove todos os n√£o-d√≠gitos

        if (cleanedValue.length === 11) { // CPF
            return cleanedValue.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        } else if (cleanedValue.length === 14) { // CNPJ
            return cleanedValue.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        }
        return value; // Retorna o original se n√£o for um CPF/CNPJ v√°lido
    }

    function imprimirSelecionados() {
        const printContent = document.createElement('div');
        let hasSelection = false;
        
        // Formata o CPF/CNPJ antes de gerar o conte√∫do para impress√£o
        const printCpfCnpjSpan = document.getElementById('print-cpf-cnpj');
        const originalCpfCnpjText = printCpfCnpjSpan.innerText;
        printCpfCnpjSpan.innerText = formatCpfCnpjForPrint(originalCpfCnpjText); // üîπ Usa a nova fun√ß√£o de formata√ß√£o

        document.querySelectorAll('#print-form .form-check-input').forEach(checkbox => {
            if (checkbox.checked) {
                hasSelection = true;
                const sectionId = checkbox.id.replace('checkbox-print-', 'print-section-');
                const section = document.getElementById(sectionId);
                if (section) printContent.innerHTML += section.innerHTML;
            }
        });

        if (!hasSelection) {
            showCustomAlert('Selecione pelo menos uma se√ß√£o para imprimir.');
            // Restaura o CPF/CNPJ original se a impress√£o for cancelada
            printCpfCnpjSpan.innerText = originalCpfCnpjText;
            return;
        }

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html><head><title>Impress√£o do Cliente</title>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
            <style>body{padding:20px;} h4{margin-top:20px;border-bottom:1px solid #ccc;padding-bottom:5px;}</style>
            </head><body>
            <div align="center">
			<img src="{{ url_for('static', filename='img/logo.png') }}" width="150">
			<p><strong>CNPJ:</strong> Insira o seu <strong>WhatsApp:</strong> Insira o seu</p>
			</div>
            <hr>
            ${printContent.innerHTML}
            </body></html>`);
        printWindow.document.close();
        printWindow.print();
        
        // Restaura o CPF/CNPJ original ap√≥s a impress√£o
        printCpfCnpjSpan.innerText = originalCpfCnpjText;
    }

    function preencherEnderecoPorCep(cepInput) {
        let cep = cepInput.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        const enderecoGroup = cepInput.closest('.endereco-group'); // Encontra o grupo de endere√ßo atual
                        enderecoGroup.querySelector('input[name="endereco[]"]').value = data.logradouro || '';
                        enderecoGroup.querySelector('input[name="bairro[]"]').value = data.bairro || '';
                        enderecoGroup.querySelector('input[name="cidade[]"]').value = data.localidade || '';
                        enderecoGroup.querySelector('select[name="estado[]"]').value = data.uf || ''; // Preenche o select de estado
                    } else {
                        showCustomAlert('CEP n√£o encontrado.', 'warning');
                    }
                }).catch(error => {
                    console.error('Erro na API ViaCEP:', error);
                    showCustomAlert('Erro ao buscar CEP. Tente novamente.', 'danger');
                });
        }
    }

    // --- FUN√á√ïES DE VALIDA√á√ÉO ---
    function validarCPF(cpf) { 
            cpf = cpf.replace(/[^\d]+/g, ''); // Removes non-numeric characters
            if (cpf == '') return false;
            // Eliminates known invalid CPFs
            if (cpf.length != 11 ||
                cpf == "00000000000" ||
                cpf == "11111111111" ||
                cpf == "22222222222" ||
                cpf == "33333333333" ||
                cpf == "44444444444" ||
                cpf == "55555555555" ||
                cpf == "66666666666" ||
                cpf == "77777777777" ||
                cpf == "88888888888" ||
                cpf == "99999999999")
                return false;
            // Validates 1st digit
            let add = 0;
            for (let i = 0; i < 9; i++)
                add += parseInt(cpf.charAt(i)) * (10 - i);
            let rev = 11 - (add % 11); 
            if (rev == 10 || rev == 11)
                rev = 0;
            if (rev != parseInt(cpf.charAt(9)))
                return false;
            // Validates 2nd digit
            add = 0;
            for (let i = 0; i < 10; i++)
                add += parseInt(cpf.charAt(i)) * (11 - i);
            rev = 11 - (add % 11); 
            if (rev == 10 || rev == 11)
                rev = 0;
            if (rev != parseInt(cpf.charAt(10)))
                return false;
        return true; }
    function validarCNPJ(cnpj) { 
        cnpj = cnpj.replace(/[^\d]+/g, ''); // Removes non-numeric characters

            if (cnpj == '') {
                return false;
            }

            if (cnpj.length != 14) {
                return false;
            }

            // Eliminates known invalid CNPJs
            if (cnpj == "00000000000000" ||
                cnpj == "11111111111111" ||
                cnpj == "22222222222222" ||
                cnpj == "33333333333333" ||
                cnpj == "44444444444444" ||
                cnpj == "55555555555555" ||
                cnpj == "66666666666666" ||
                cnpj == "77777777777777" ||
                cnpj == "88888888888888" ||
                cnpj == "99999999999999") {
                return false;
            }

            // Validates DVs
            let tamanho = cnpj.length - 2;
            let numeros = cnpj.substring(0, tamanho);
            let digitos = cnpj.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;
            
            for (let i = tamanho; i >= 1; i--) {
                soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
                if (pos < 2) {
                    pos = 9;
                }
            }
            
            let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11; 
            if (resultado != parseInt(digitos.charAt(0))) {
                return false;
            }

            tamanho = tamanho + 1;
            numeros = cnpj.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
            
            for (let i = tamanho; i >= 1; i--) {
                soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
                if (pos < 2) {
                    pos = 9;
                }
            }
            
            resultado = soma % 11 < 2 ? 0 : 11 - soma % 11; 
            if (resultado != parseInt(digitos.charAt(1))) {
                return false;
            }
        return true; }
    function validateCpfCnpjInput() {
        var input = $('#cpf_cnpj'), error = $('#cpfCnpjError'), hiddenCpf = $('#hidden_cpf'), hiddenCnpj = $('#hidden_cnpj');
        var valor = input.val().replace(/\D/g, '');
        error.hide(); hiddenCpf.val(''); hiddenCnpj.val('');
        if (valor === '') return true;
        if (valor.length === 11) {
            if (validarCPF(valor)) { hiddenCpf.val(valor); return true; } 
            else { error.text('CPF inv√°lido.').show(); return false; }
        } else if (valor.length === 14) {
            if (validarCNPJ(valor)) { hiddenCnpj.val(valor); return true; } 
            else { error.text('CNPJ inv√°lido.').show(); return false; }
        } else {
            error.text('Documento com tamanho inv√°lido.').show(); return false;
        }
    }

    // --- FUN√á√ïES DE M√ÅSCARA E EVENTOS ---
    function applyMasks() {
        var cpfCnpjMask = function(val) { return val.replace(/\D/g, '').length <= 11 ? '000.000.000-009' : '00.000.000/0000-00'; };
        $('#cpf_cnpj').mask(cpfCnpjMask, { onKeyPress: function(val, e, field, options) { field.mask(cpfCnpjMask.apply({}, arguments), options); } });
        $('.cep-input').mask('00000-000');
        $('.placa-input').mask('SSS-0A00', { translation: { 'S': { pattern: /[A-Za-z]/ }, 'A': { pattern: /[0-9A-Ja-j]/ } }, onKeyPress: function(val, e, field, options){ $(field).mask(val.length > 4 && /[A-Za-z]/.test(val.charAt(4)) ? 'SSS-0A00' : 'SSS-0000', options); } });
        $('.ano-input').mask('0000');
        $('.telefone-input').mask('(00) 00000-0000');
        $('.money-input').mask('000.000.000.000.000,00', {reverse: true, placeholder: "0,00"}); // üîπ Aplicando m√°scara de dinheiro
    }

    // üîπ Fun√ß√£o para obter o ID da aba ativa
    function getActiveTabId() {
        const activeTabButton = document.querySelector('#clientTab .nav-link.active');
        return activeTabButton ? activeTabButton.id.replace('-tab', '-pane') : 'dados-pessoais-pane'; // Retorna o ID do painel
    }

    // üîπ Fun√ß√£o para ativar a aba ao carregar a p√°gina
    function setActiveTabOnLoad() {
        const urlParams = new URLSearchParams(window.location.search);
        const tabToActivate = urlParams.get('tab');

        if (tabToActivate) {
            const tabButton = document.getElementById(tabToActivate.replace('-pane', '-tab'));
            if (tabButton) {
                const bsTab = new bootstrap.Tab(tabButton);
                bsTab.show();
            }
        }
    }

    $(document).ready(function() {
        applyMasks();
        $('#cpf_cnpj').on('blur', validateCpfCnpjInput);
        
        const addressModal = document.getElementById('addressModal');
        addressModal.addEventListener('show.bs.modal', function () {
            // Limpa o container para n√£o duplicar campos ao reabrir o modal
            const container = document.getElementById('enderecos-container');
            container.innerHTML = ''; 

            // Pega os dados de endere√ßo do Jinja e cria os campos dinamicamente
            const ceps = "{{ cliente.cep or '' }}".split(';').map(s => s.trim());
            const enderecos = "{{ cliente.endereco or '' }}".split(';').map(s => s.trim());
            const numeros = "{{ cliente.numero or '' }}".split(';').map(s => s.trim());
            const complementos = "{{ cliente.complemento or '' }}".split(';').map(s => s.trim());
            const bairros = "{{ cliente.bairro or '' }}".split(';').map(s => s.trim());
            const cidades = "{{ cliente.cidade or '' }}".split(';').map(s => s.trim());
            const estados = "{{ cliente.estado or '' }}".split(';').map(s => s.trim());

            // Encontra o maior comprimento para garantir que todos os arrays s√£o iterados
            const maxLength = Math.max(ceps.length, enderecos.length, numeros.length, complementos.length, bairros.length, cidades.length, estados.length);

            if (maxLength > 0 && (ceps[0] !== '' || enderecos[0] !== '')) {
                for (let i = 0; i < maxLength; i++) {
                    adicionarCampoEndereco(
                        ceps[i] || '',
                        enderecos[i] || '',
                        numeros[i] || '',
                        complementos[i] || '',
                        bairros[i] || '',
                        cidades[i] || '',
                        estados[i] || '',
                        i === 0 // Marca o primeiro como principal
                    );
                }
            } else {
                // Se n√£o houver nenhum endere√ßo, adiciona um campo em branco
                adicionarCampoEndereco('', '', '', '', '', '', '', true); // Adiciona um campo principal vazio
            }
            updatePrincipalRadioNames(); // Garante que os nomes dos r√°dios estejam corretos ap√≥s o carregamento
        });

        // Event listener para o bot√£o "Adicionar campo de endere√ßo"
        document.getElementById('addEnderecoBtn').addEventListener('click', function() {
            adicionarCampoEndereco('', '', '', '', '', '', '', false); // Adiciona um novo campo vazio, n√£o principal
            updatePrincipalRadioNames(); // Atualiza os nomes dos r√°dios
        });

        // Event listener para remover endere√ßo
        document.getElementById('enderecos-container').addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-endereco-btn') || e.target.closest('.remove-endereco-btn')) {
                const enderecoGroup = e.target.closest('.endereco-group');
                if (document.querySelectorAll('.endereco-group').length > 1) {
                    enderecoGroup.remove();
                    updateEnderecoRemoveButtons();
                    updatePrincipalRadioNames(); // Atualiza os nomes ap√≥s a remo√ß√£o
                }
            }
        });


        // Inicializa estado dos formul√°rios de pagamento
        $('form[id^="form_pagamento_"], form[id^="editPagamentoModal"]').each(function() {
            const selectMetodo = this.querySelector('select[name="metodo"]');
            if (selectMetodo) {
                toggleOpcaoPagamento(selectMetodo); 
                const selectTipo = this.querySelector('select[name="tipo_pagamento"]');
                if (selectTipo) {
                    toggleParcelas(selectTipo);
                }
            }
        });

        // üîπ Adiciona listener para todos os formul√°rios para preencher o campo active_tab
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                let activeTabInput = form.querySelector('input[name="active_tab"]');
                if (!activeTabInput) { // Se o input n√£o existir (alguns formul√°rios j√° t√™m), cria um
                    activeTabInput = document.createElement('input');
                    activeTabInput.type = 'hidden';
                    activeTabInput.name = 'active_tab';
                    form.appendChild(activeTabInput);
                }
                activeTabInput.value = getActiveTabId();
            });
        });
        
        // --- BLOCO DE C√ìDIGO CORRIGIDO ---
        // Limpeza de m√°scaras e valida√ß√£o antes de enviar
        $('#editClientForm, #addCarroForm, #addTelefoneForm').submit(function(event) {
            // Valida√ß√£o espec√≠fica para o formul√°rio de edi√ß√£o de cliente
            if (this.id === 'editClientForm' && !validateCpfCnpjInput()) {
                // Apenas impede o envio do formul√°rio. A mensagem de erro j√° √© exibida pela fun√ß√£o de valida√ß√£o.
                event.preventDefault();
                return; 
            }
            
            // Remove a m√°scara dos campos antes do envio para todos os formul√°rios relevantes
            $(this).find('.cep-input, .telefone-input').each(function() { $(this).val($(this).val().replace(/\D/g, '')); });
            $(this).find('.placa-input').each(function() { $(this).val($(this).val().replace('-', '').toUpperCase()); });
            $(this).find('.money-input').each(function() { // üîπ Limpeza para campos de dinheiro
                let val = $(this).val();
                val = val.replace(/\./g, ''); // Remove pontos de milhar
                val = val.replace(',', '.'); // Troca v√≠rgula por ponto decimal
                $(this).val(val);
            });
        });
        // --- FIM DO BLOCO CORRIGIDO ---

        // üîπ Ativa a aba correta ao carregar a p√°gina
        setActiveTabOnLoad();
    });
</script>
</body>
</html>